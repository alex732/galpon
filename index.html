<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud v3.0 | Control Maestro üá©üá¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root {
            --bg: #0a0f1d; --card: #161e31; --accent: #3b82f6;
            --danger: #ef4444; --success: #22c55e; --warn: #f59e0b;
        }

        body {
            background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px; transition: background 0.5s;
        }

        /* Alerta de P√°nico: Parpadeo de toda la pantalla */
        body.panic-mode { animation: panic-bg 1s infinite; }
        @keyframes panic-bg { 0% { background: #0a0f1d; } 50% { background: #450a0a; } 100% { background: #0a0f1d; } }

        .main-grid { display: grid; grid-template-columns: 1fr 3fr 1fr; gap: 20px; max-width: 1600px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 15px; border: 1px solid #2d3748; position: relative; }
        
        /* Video Optimizado */
        #foscam-stream { width: 100%; height: 400px; background: #000; border-radius: 10px; object-fit: contain; }
        
        /* Contador de Lote */
        .batch-counter { text-align: center; padding: 10px; border-bottom: 2px solid var(--accent); margin-bottom: 15px; }
        .days-val { font-size: 3rem; font-weight: bold; color: var(--success); }

        /* Gauges */
        .gauges-box { display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; border-radius: 10px; padding: 10px; }

        /* Log Terminal */
        .log-win { height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; background: #000; padding: 10px; border-radius: 5px; color: #0f0; }
        .log-err { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="main-grid">
    
    <div class="card">
        <div class="batch-counter">
            <div class="label">EDAD DEL LOTE</div>
            <div class="days-val" id="batch-days">0</div>
            <div>D√çAS</div>
        </div>
        <div id="target-temp" style="font-size: 0.9rem; color: var(--warn); text-align: center;">
            Temp. Objetivo: --¬∞C
        </div>
        <hr style="opacity:0.2">
        <h4>LLUVIA RD</h4>
        <div id="rain-status" style="font-size: 1.5rem; text-align: center;">--</div>
    </div>

    <div class="card">
        <div style="position: absolute; top: 20px; left: 25px; background: red; padding: 2px 8px; border-radius: 5px; font-size: 0.7rem;">LIVE</div>
        <img id="foscam-stream" src="" alt="Cargando video optimizado...">
        
        <div style="margin-top:15px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
            <strong style="color:var(--accent)">üí° RECOMENDACI√ìN T√âCNICA:</strong>
            <div id="ia-advice">Estabilizando sistema...</div>
        </div>
    </div>

    <div class="card">
        <h3 style="text-align:center; font-size: 1rem;">ESTADO CR√çTICO</h3>
        <div class="gauges-box">
            <div id="g_t"></div>
            <div id="g_h"></div>
            <div id="g_n"></div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <h3>REGISTRO DE EVENTOS (LOG)</h3>
    <div id="event-log" class="log-win"></div>
</div>

<script>
    // 1. CONFIGURACI√ìN
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Fecha de inicio del lote (Ajusta esta fecha cada vez que llegue un lote nuevo)
    const FECHA_INICIO = new Date("2026-01-10"); 

    // 2. VIDEO OPTIMIZADO (Ajuste de latencia)
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        // Bajamos a 800ms para mayor fluidez si
