/* ================= CAMARA ================= */
const IP  = "192.168.2.193:88";
const USR = "alex";
const PWD = "F7324088";
const base = `http://${IP}/cgi-bin/CGIProxy.fcgi?usr=${USR}&pwd=${PWD}`;

function activarVideo(){
    // Paso 1: Abrimos la ventana que ya sabemos que rompe el bloqueo
    window.open(base+"&cmd=getDevState","auth","width=300,height=200");
    
    setTimeout(()=>{
        const img = document.getElementById("foscam-stream");
        const btn = document.getElementById("btn-play");
        const loading = document.getElementById("loading-text");

        // Intentamos el flujo MJPEG estándar
        const streamUrl = `${base}&cmd=getLiveStream&type=1&_ts=${Date.now()}`;
        img.src = streamUrl;
        img.style.display="block";
        loading.style.display="none";
        
        // Verificamos si la imagen cargó realmente
        img.onload = () => {
            btn.innerText="✅ VIDEO CONECTADO";
            btn.style.background="#22c55e";
        };

        // Si el stream falla, usamos el "Modo Ráfaga" (Snapshot cada segundo)
        img.onerror = () => {
            console.log("Stream bloqueado, iniciando modo ráfaga...");
            setInterval(() => {
                img.src = `${base}&cmd=snapShot&_ts=${Date.now()}`;
            }, 1000);
            btn.innerText="✅ MODO FOTO (CHROME SAFE)";
            btn.style.background="#f59e0b"; // Naranja para avisar que es modo ráfaga
        };
    }, 2000);
}

function mover(cmd){ fetch(`${base}&cmd=${cmd}`).catch(()=>{}); }

/* ================= FIREBASE ================= */
firebase.initializeApp({
    databaseURL:"https://galpon-capellan-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ================= GAUGES ================= */
const gOpts = {
    angle:-0.2, lineWidth:0.2,
    pointer:{length:0.6,color:"#fff"},
    staticZones:[
        {strokeColor:"#22c55e",min:0,max:20},
        {strokeColor:"#ef4444",min:20,max:100}
    ]
};

const gNH3  = new Gauge(document.getElementById("gauge-nh3")).setOptions(gOpts);
const gTemp = new Gauge(document.getElementById("gauge-temp")).setOptions(gOpts);
gNH3.maxValue=100; gTemp.maxValue=50;

function colorVal(el,val,limit){
    el.style.color = val>limit ? "#ef4444" : "#22c55e";
}

db.ref("galpon/actual").on("value",snap=>{
    const d=snap.val();
    if(!d) return;

    if(d.nh3_ppm!=null){
        gNH3.set(d.nh3_ppm);
        const e=document.getElementById("val-nh3");
        e.innerText=d.nh3_ppm+" ppm";
        colorVal(e,d.nh3_ppm,20);
    }

    if(d.temperatura!=null){
        gTemp.set(d.temperatura);
        const eT=document.getElementById("val-temp");
        eT.innerText=d.temperatura+"°C";
        colorVal(eT,d.temperatura,31);
    }
});
