<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capell√°n Cloud | Control Remoto</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; --safe: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: 20px auto; }
        .card { background: var(--card); border-radius: 20px; padding: 20px; border: 5px solid #334155; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); }
        .val { font-size: 3.5rem; font-weight: bold; margin: 10px 0; transition: color 0.3s; }
        .cam-box { width: 100%; height: 320px; background: #000; border-radius: 15px; border: 3px solid var(--primary); display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; display: none; }
        .btn-auth { background: var(--danger); color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1rem; }
        .ptz-btn { background: #334155; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; margin: 3px; width: 55px; font-size: 1.2rem; }
        .ptz-btn:hover { background: var(--primary); }
    </style>
</head>
<body>

    <h1 style="color: var(--primary); letter-spacing: 1px;">CONTROL GALP√ìN CAPELL√ÅN üö¶</h1>

    <div class="grid">
        <div id="card-nh3" class="card">
            <h3>AMON√çACO (NH3)</h3>
            <canvas id="gauge-nh3" style="width: 100%; height: 160px;"></canvas>
            <div id="val-nh3" class="val">--</div>
            <p id="label-nh3" style="font-weight: bold;">SIN DATOS</p>
        </div>

        <div id="card-temp" class="card">
            <h3>TEMPERATURA</h3>
            <canvas id="gauge-temp" style="width: 100%; height: 160px;"></canvas>
            <div id="val-temp" class="val">--</div>
            <p id="label-temp" style="font-weight: bold;">SIN DATOS</p>
        </div>

        <div class="card" style="border-color: var(--primary);">
            <button id="btn-play" class="btn-auth" onclick="activarVideo()">PASO 1: CONECTAR C√ÅMARA REMOTA</button>
            <div class="cam-box">
                <img id="foscam-stream" src="">
                <div id="load-txt" style="color: #64748b;">Esperando se√±al remota...</div>
            </div>
            <div style="margin-top:15px;">
                <button class="ptz-btn" onclick="mover('ptzMoveUp')">‚ñ≤</button><br>
                <button class="ptz-btn" onclick="mover('ptzMoveLeft')">‚óÑ</button>
                <button class="ptz-btn" onclick="mover('ptzReset')">üè†</button>
                <button class="ptz-btn" onclick="mover('ptzMoveRight')">‚ñ∫</button><br>
                <button class="ptz-btn" onclick="mover('ptzMoveDown')">‚ñº</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACI√ìN √ìPTIMA DDNS
        const USR = "alex";
        const PWD = "F7324088";
        // Usamos la URL que vimos en tu configuraci√≥n remota
        const base = "http://ii9315.myfoscam.org:88/cgi-bin/CGIProxy.fcgi?usr=" + USR + "&pwd=" + PWD;

        // FIREBASE
        firebase.initializeApp({ databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" });
        const db = firebase.database();

        // GAUGES
        const gOpts = { angle: -0.2, lineWidth: 0.2, pointer: { length: 0.6, color: "#fff" }, staticZones: [{strokeColor: "#22c55e", min: 0, max: 20}, {strokeColor: "#ef4444", min: 20, max: 100}] };
        const gNH3 = new Gauge(document.getElementById("gauge-nh3")).setOptions(gOpts);
        const gTemp = new Gauge(document.getElementById("gauge-temp")).setOptions(gOpts);
        gNH3.maxValue = 100; gTemp.maxValue = 50;

        function activarVideo() {
            // Abrir permiso en ventana nueva
            window.open(base + "&cmd=getDevState", "auth", "width=300,height=200");
            
            setTimeout(() => {
                const img = document.getElementById("foscam-stream");
                const btn = document.getElementById("btn-play");
                img.style.display = "block";
                document.getElementById("load-txt").style.display = "none";
                
                // MODO R√ÅFAGA √ìPTIMO (1 foto cada 1.2 segundos para no saturar la red remota)
                setInterval(() => {
                    img.src = base + "&cmd=snapShot&_ts=" + Date.now();
                }, 1200);

                btn.innerText = "‚úÖ VISTA REMOTA ACTIVA";
                btn.style.background = "#22c55e";
            }, 2500);
        }

        function mover(cmd) { 
            const i = new Image();
            i.src = base + "&cmd=" + cmd + "&_ts=" + Date.now();
        }

        // ACTUALIZACI√ìN DE DATOS
        db.ref("galpon/actual").on("value", snap => {
            const d = snap.val();
            if(!d) return;
            if(d.nh3_ppm != null) {
                gNH3.set(d.nh3_ppm);
                const valEl = document.getElementById("val-nh3");
                const lblEl = document.getElementById("label-nh3");
                valEl.innerText = d.nh3_ppm + " ppm";
                lblEl.innerText = d.nh3_ppm > 20 ? "üö® ALERTA AMON√çACO" : "‚úÖ AIRE LIMPIO";
                lblEl.style.color = d.nh3_ppm > 20 ? "#ef4444" : "#22c55e";
                valEl.style.color = d.nh3_ppm > 20 ? "#ef4444" : "#22c55e";
            }
            if(d.temperatura != null) {
                gTemp.set(d.temperatura);
                const valT = document.getElementById("val-temp");
                const lblT = document.getElementById("label-temp");
                valT.innerText = d.temperatura + "¬∞C";
                lblT.innerText = d.temperatura > 31 ? "üö® CALOR EXCESIVO" : "‚úÖ TEMP. OK";
                lblT.style.color = d.temperatura > 31 ? "#ef4444" : "#22c55e";
                valT.style.color = d.temperatura > 31 ? "#ef4444" : "#22c55e";
            }
        });
    </script>
</body>
</html>
