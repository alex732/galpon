<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capellán Cloud | Directriz Chrome</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; text-align: center; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; border: 4px solid #334155; }
        .val { font-size: 3.5rem; font-weight: bold; }
        /* El contenedor de video según Chrome debe estar oculto hasta ser autorizado */
        #cam-layer { width: 100%; border-radius: 10px; border: 2px solid var(--primary); background: #000; min-height: 250px; display: none; }
        .btn-auth { background: #ef4444; color: white; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
    </style>
</head>
<body>

    <h1 style="color: var(--primary);">CONTROL GALPÓN CAPELLÁN</h1>

    <div class="grid">
        <div class="card">
            <h3>AMONÍACO (NH3)</h3>
            <canvas id="gauge-nh3" style="width:100%"></canvas>
            <div id="val-nh3" class="val">--</div>
        </div>

        <div class="card">
            <h3>TEMPERATURA</h3>
            <canvas id="gauge-temp" style="width:100%"></canvas>
            <div id="val-temp" class="val">--</div>
        </div>

        <div class="card" style="border-color: var(--primary);">
            <h3>VISTA EN VIVO</h3>
            <button id="auth-btn" class="btn-auth" onclick="iniciarConexion()">CLIC AQUÍ PARA AUTORIZAR VIDEO</button>
            <img id="cam-layer" src="">
            <p id="status-text" style="font-size: 0.8rem; margin-top:10px; color: #94a3b8;">Estado: Esperando autorización...</p>
        </div>
    </div>

    <script>
        const IP = "192.168.2.193:88";
        const USR = "alex";
        const PWD = "F7324088";
        const base = `http://${IP}/cgi-bin/CGIProxy.fcgi?usr=${USR}&pwd=${PWD}`;

        // Esta función cumple la directriz de "Interacción de Usuario" de Google
        function iniciarConexion() {
            // 1. Abrimos brevemente una ventana para que Chrome confíe en el origen HTTP
            const testWin = window.open(base + "&cmd=getDevState", "auth", "width=10,height=10");
            
            document.getElementById('auth-btn').style.display = 'none';
            document.getElementById('cam-layer').style.display = 'block';
            document.getElementById('status-text').innerText = "Conectando a Flujo MJPEG...";

            setTimeout(() => {
                if(testWin) testWin.close();
                // Cargamos el stream secundario (type=1) que es el que soporta Chrome nativamente
                document.getElementById('cam-layer').src = `${base}&cmd=getLiveStream&type=1`;
            }, 2000);
        }

        window.onload = function() {
            firebase.initializeApp({ databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" });
            const db = firebase.database();
            
            // Configurar Gauges
            const gNH3 = new Gauge(document.getElementById('gauge-nh3')).setOptions({angle:-0.2,lineWidth:0.2,pointer:{length:0.6,color:'#FFF'},staticZones:[{strokeColor:"#22c55e",min:0,max:20},{strokeColor:"#ef4444",min:20,max:100}]});
            const gTemp = new Gauge(document.getElementById('gauge-temp')).setOptions({angle:-0.2,lineWidth:0.2,pointer:{length:0.6,color:'#FFF'},staticZones:[{strokeColor:"#22c55e",min:0,max:20},{strokeColor:"#ef4444",min:20,max:100}]});
            gNH3.maxValue = 100; gTemp.maxValue = 50;

            db.ref('galpon/actual').on('value', (snap) => {
                const d = snap.val();
                if(d) {
                    gNH3.set(d.nh3_ppm); document.getElementById('val-nh3').innerText = d.nh3_ppm;
                    gTemp.set(d.temperatura); document.getElementById('val-temp').innerText = d.temperatura + "°C";
                }
            });
        };
    </script>
</body>
</html>
