<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell치n Cloud | Control Sem치foro RD 游뾇릖</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; }
        body { background: var(--bg); color: white; font-family: sans-serif; padding: 20px; }
        .main-container { max-width: 1200px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #334155; margin-bottom: 20px; text-align: center; }
        .gauge-container { display: flex; justify-content: space-around; flex-wrap: wrap; background: white; border-radius: 10px; padding: 20px; margin-top: 15px; }
        #foscam-stream { width: 100%; height: 350px; background: #000; border-radius: 10px; object-fit: contain; border: 2px solid var(--blue); }
        .advice-box { background: #334155; padding: 15px; border-radius: 10px; margin-top: 10px; border-left: 5px solid var(--blue); text-align: left; }
    </style>
</head>
<body>

<div class="main-container">
    <h1 style="text-align:center; color: var(--blue);">CAPELL츼N CLOUD - MONITOREO CR칈TICO</h1>

    <div class="card">
        <img id="foscam-stream" src="" alt="Cargando video...">
        <div id="v-status">Iniciando flujo...</div>
    </div>

    <div class="card">
        <h3 style="color: #1e293b; background: #94a3b8; padding: 5px; border-radius: 5px;">ESTADO DEL AMBIENTE (L칍GICA POLLOS DE ENGORDE)</h3>
        <div class="gauge-container">
            <div id="gauge_temp"></div>
            <div id="gauge_hum"></div>
            <div id="gauge_nh3"></div>
        </div>
        
        <div class="advice-box">
            <strong>游늶 RECOMENDACI칍N T칄CNICA (RD):</strong>
            <span id="txt-consejo">Analizando datos en tiempo real...</span>
        </div>
    </div>
</div>

<script>
    // 1. FIREBASE
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. CONFIGURAR MEDIDORES (GOOGLE CHARTS)
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(iniciarGauges);

    let datTemp, datHum, datNh3, chartTemp, chartHum, chartNh3;

    function iniciarGauges() {
        // Configuraci칩n de Sem치foro para RD
        datTemp = google.visualization.arrayToDataTable([['Label', 'Value'], ['Temp 춿C', 0]]);
        chartTemp = new google.visualization.Gauge(document.getElementById('gauge_temp'));
        let optTemp = { width: 250, height: 250, redFrom: 32, redTo: 45, yellowFrom: 29, yellowTo: 32, greenFrom: 20, greenTo: 29, minorTicks: 5, max: 45 };

        datHum = google.visualization.arrayToDataTable([['Label', 'Value'], ['Hum %', 0]]);
        chartHum = new google.visualization.Gauge(document.getElementById('gauge_hum'));
        let optHum = { width: 250, height: 250, redFrom: 80, redTo: 100, yellowFrom: 70, yellowTo: 80, greenFrom: 50, greenTo: 70, minorTicks: 5 };

        datNh3 = google.visualization.arrayToDataTable([['Label', 'Value'], ['NH3 PPM', 0]]);
        chartNh3 = new google.visualization.Gauge(document.getElementById('gauge_nh3'));
        let optNh3 = { width: 250, height: 250, redFrom: 20, redTo: 50, yellowFrom: 10, yellowTo: 20, greenFrom: 0, greenTo: 10, minorTicks: 2, max: 50 };

        // Escuchar Firebase
        db.ref('galpon/actual').on('value', (snapshot) => {
            const d = snapshot.val();
            if(d) {
                // Actualizar Gauges
                datTemp.setValue(0, 1, d.temperatura); chartTemp.draw(datTemp, optTemp);
                datHum.setValue(0, 1, d.humedad); chartHum.draw(datHum, optHum);
                datNh3.setValue(0, 1, d.nh3_ppm); chartNh3.draw(datNh3, optNh3);

                // L칩gica de mejores pr치cticas para pollos en RD
                actualizarConsejo(d.temperatura, d.nh3_ppm, d.humedad);
            }
        });
    }

    function actualizarConsejo(t, n, h) {
        const caja = document.getElementById('txt-consejo');
        if(t > 31) caja.innerHTML = "<strong>ESTR칄S CAL칍RICO:</strong> Reduzca densidad o use ventiladores. En RD el calor del mediod칤a es cr칤tico.";
        else if(n > 20) caja.innerHTML = "<strong>ALERTA AMON칈ACO:</strong> Cambie o remueva cama h칰meda. Riesgo de quemaduras en patas y ceguera.";
        else if(h > 75) caja.innerHTML = "<strong>HUMEDAD ALTA:</strong> Peligro de hongos. Aumente la ventilaci칩n cruzada.";
        else caja.innerHTML = "Condiciones ideales para el crecimiento del lote.";
    }

    // 3. VIDEO AUTOM츼TICO
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1200);
    };
</script>
</body>
</html>
