<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capell√°n Cloud - Gauges</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        body { background: #0f172a; color: #f1f5f9; font-family: sans-serif; padding: 15px; text-align: center; margin: 0; }
        .gauges-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px auto; max-width: 900px; background: #1e293b; padding: 20px; border-radius: 20px; }
        .gauge-box { background: #334155; padding: 10px; border-radius: 15px; }
        .status { color: #22c55e; font-size: 0.8rem; margin-bottom: 10px; }
        .rain-card { background: #1e293b; padding: 15px; border-radius: 12px; max-width: 200px; margin: 10px auto; border-top: 4px solid #3b82f6; }
        
        /* Historiales */
        .section-title { text-align: left; max-width: 800px; margin: 20px auto 10px; color: #94a3b8; font-size: 0.9rem; font-weight: bold; border-left: 4px solid #3b82f6; padding-left: 10px; }
        .log-container { background: #1e293b; border-radius: 10px; max-width: 800px; margin: 0 auto 20px; border: 1px solid #334155; overflow: hidden; }
        .log-entry { padding: 10px 15px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; font-size: 0.85em; text-align: left; }
        .critical { border-left: 5px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        table { width: 100%; max-width: 800px; margin: 0 auto; background: #1e293b; border-radius: 10px; font-size: 0.85rem; border-collapse: collapse; }
        th { background: #334155; color: #94a3b8; padding: 10px; }
        td { padding: 8px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>
    <h2 style="margin: 10px 0;">üõ∞Ô∏è CAPELL√ÅN CLOUD GAUGES</h2>
    <div id="st" class="status">Cargando instrumentos...</div>
    
    <div class="gauges-container">
        <div id="chart_temp" class="gauge-box"></div>
        <div id="chart_hum" class="gauge-box"></div>
        <div id="chart_nh3" class="gauge-box"></div>
    </div>

    <div class="rain-card">LLUVIA: <strong id="l">--</strong></div>

    <div class="section-title">‚ö†Ô∏è Recomendaciones</div>
    <div class="log-container" id="reco-log"><div style="padding:15px">Esperando datos...</div></div>

    <div class="section-title">üìú Historial</div>
    <table>
        <thead><tr><th>Hora</th><th>T</th><th>H</th><th>NH3</th><th>Lluvia</th></tr></thead>
        <tbody id="data-hist"></tbody>
    </table>
function escucharDatos() {
        console.log("Intentando conectar a Firebase...");
        
        db.ref('galpon/actual').on('value', (snapshot) => {
            const d = snapshot.val();
            console.log("Datos recibidos de Firebase:", d);

            if (d) {
                const hora = new Date().toLocaleTimeString();
                
                // USAMOS LOS NOMBRES QUE VEMOS EN TU CONSOLA
                // temperatura, humedad, nh3_ppm, lluvia
                if(d.temperatura !== undefined) { dataT.setValue(0, 1, d.temperatura); chartT.draw(dataT, optionsT); }
                if(d.humedad !== undefined) { dataH.setValue(0, 1, d.humedad); chartH.draw(dataH, optionsH); }
                if(d.nh3_ppm !== undefined) { dataN.setValue(0, 1, d.nh3_ppm); chartN.draw(dataN, optionsN); }
                
                document.getElementById('l').innerText = d.lluvia || "--";
                document.getElementById('st').innerText = "CONECTADO - " + hora;
                document.getElementById('st').style.color = "#22c55e";

                // Actualizar tabla de historial (ajustado a nombres largos)
                actualizarHistorial(d, hora);
            }
        });
    }

    function actualizarHistorial(d, hora) {
        // Ajustamos tambi√©n aqu√≠ los nombres
        logsData.unshift({h:hora, t:d.temperatura, hu:d.humedad, n:d.nh3_ppm, l:d.lluvia});
        if(logsData.length > 8) logsData.pop();
        let htm = "";
        logsData.forEach(e => { 
            htm += `<tr><td>${e.h}</td><td>${e.t}¬∞</td><td>${e.hu}%</td><td>${e.n}</td><td>${e.l}</td></tr>`; 
        });
        document.getElementById('data-hist').innerHTML = htm;
    }
</body>
</html>
