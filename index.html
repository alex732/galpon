<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Zentinel Cloud üá©üá¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        
        /* HEADER */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; }
        .header-title { font-size: 20px; font-weight: bold; }
        .header-clock { color: #94a3b8; font-family: monospace; }
        
        /* GRID */
        .layout-grid { display: grid; gap: 10px; grid-template-columns: 1fr; }
        @media(min-width: 1000px) { .layout-grid { grid-template-columns: 180px 1fr 300px; } }

        /* CARDS */
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 8px; margin-bottom: 8px; display:flex; flex-direction:column; }
        .card-title { font-size: 10px; color: #94a3b8; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid #334155; }

        /* RELOJES */
        .gauge-box { background: #0f172a; border-radius: 50%; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 10px auto; border: 4px solid #334155; transition: border-color 0.5s; }
        .g-green { border-color: #22c55e; color: #4ade80; }
        .g-red { border-color: #ef4444; color: #f87171; }
        .val-text { font-size: 22px; font-weight: bold; }
        .lbl-text { font-size: 9px; color: #94a3b8; }

        /* VIDEO */
        .video-main { width: 100%; height: 350px; background: #000; border-radius: 6px; object-fit: cover; border: 1px solid #334155; }
        
        /* üî• RECOMENDACI√ìN ACTUAL */
        .rec-box { 
            background: #0f172a; border-left: 4px solid #38bdf8; 
            padding: 10px; border-radius: 4px; font-size: 14px; 
            color: #e2e8f0; margin-bottom: 10px; min-height: 40px;
            display: flex; align-items: center;
        }

        /* üî• HISTORIAL IA (LISTA) */
        .ia-list { height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .ia-item { background: #0f172a; padding: 6px; border-radius: 4px; border: 1px solid #334155; font-size: 11px; color: #94a3b8; }
        .ia-item span { color: #38bdf8; font-weight: bold; display: block; margin-bottom: 2px; }

        /* TABLA LOCAL */
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { text-align: left; border-bottom: 1px solid #334155; color: #38bdf8; }
        td { border-bottom: 1px solid #33415555; padding: 3px; color: #94a3b8; }

        /* SISTEMA */
        .pi-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; font-size:9px; }
        .stat-box { background: #0f172a; padding: 4px; border-radius: 3px; text-align: center; border: 1px solid #334155; }
        .stat-val { color: #38bdf8; font-weight: bold; }

        iframe { width: 100%; border: none; border-radius: 4px; display: block; }
    </style>
</head>
<body>

    <div class="header-bar">
        <div class="header-title">ZENTINEL <span style="color:#38bdf8">CLOUD</span></div>
        <div id="clock" class="header-clock">--:--:--</div>
    </div>

    <div class="layout-grid">
        
        <div class="col-left">
            <div class="card">
                <div id="bgT" class="gauge-box"><span id="vT" class="val-text">--</span><span class="lbl-text">TEMP</span></div>
                <div id="bgH" class="gauge-box"><span id="vH" class="val-text">--</span><span class="lbl-text">HUM</span></div>
                <div id="bgN" class="gauge-box"><span id="vN" class="val-text">--</span><span class="lbl-text">NH3</span></div>
                <div id="bgR" class="gauge-box"><span id="vR" style="font-size:30px;">‚òÄÔ∏è</span><span id="lR" class="lbl-text">SECO</span></div>
                <div style="text-align:center; font-size:10px; margin-top:5px;">MOTOR: <b id="mot" style="color:#eab308">--</b></div>
            </div>
        </div>

        <div class="col-center">
            
            <div class="card" style="border-color:#38bdf8;">
                <div class="card-title" style="color:#38bdf8;">üì¢ AN√ÅLISIS IA ACTUAL</div>
                <div id="current-rec" class="rec-box">Esperando datos de la IA...</div>
            </div>

            <img id="live" class="video-main" src="" alt="Cargando imagen...">

            <div class="card" style="margin-top:8px; height:150px; overflow-y:auto;">
                <div class="card-title">HISTORIAL MEDICIONES (GUARDADO EN TU EQUIPO)</div>
                <table id="local-table">
                    <thead><tr><th>HORA</th><th>T</th><th>H</th><th>N</th><th>LLUVIA</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button onclick="clearLocalHist()" style="width:100%; background:#334155; color:white; border:none; margin-top:5px; cursor:pointer;">Borrar Historial Local</button>
            </div>
        </div>

        <div class="col-right">
            <div class="card"><div class="card-title">SISTEMA</div>
                <div class="pi-grid">
                    <div class="stat-box"><span id="piIP" class="stat-val">--</span><br>IP</div>
                    <div class="stat-box"><span id="stArd" class="stat-val">--</span><br>ARDUINO</div>
                    <div class="stat-box"><span id="stIA" class="stat-val">--</span><br>CEREBRO IA</div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">üìú HISTORIAL DE CONSEJOS IA</div>
                <div id="ia-history" class="ia-list"></div>
            </div>

            <div class="card"><div class="card-title">VIENTO (WINDY)</div><iframe height="150" src="https://embed.windy.com/embed2.html?lat=19.780&lon=-70.687&zoom=8&level=surface&overlay=wind&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&detailLat=19.780&detailLon=-70.687&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1"></iframe></div>
            <div class="card"><div class="card-title">LLUVIA (RADAR DO)</div><iframe height="200" src="https://radar-met2.sna.gob.do/"></iframe></div>
        </div>

    </div>

    <script>
        // üî• CONEXI√ìN A FIREBASE
        var firebaseConfig = {
            databaseURL: "https://zentinel-ia-default-rtdb.firebaseio.com/"
        };
        firebase.initializeApp(firebaseConfig);
        var ref = firebase.database().ref('zentinel');

        let lastTimestamp = ""; // Para detectar cambios

        // Cargar historial local al iniciar
        renderLocalTable();

        function setG(id, v, min, max) { 
            let el=document.getElementById('v'+id); let bg=document.getElementById('bg'+id); 
            el.innerText=v; let val=parseFloat(v); 
            bg.className='gauge-box '+(val>max?'g-red':val>min?'g-yellow':'g-green'); 
        }

        ref.on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            // 1. Sensores
            setG('T', data.t, 28, 30);
            setG('H', data.h, 65, 75);
            setG('N', data.n, 15, 25);
            
            let isR = data.r == 'SI';
            document.getElementById('vR').innerText = isR ? '‚õàÔ∏è' : '‚òÄÔ∏è';
            document.getElementById('lR').innerText = isR ? 'LLUVIA' : 'SECO';
            document.getElementById('bgR').className = 'gauge-box ' + (isR ? 'g-red' : 'g-green');
            document.getElementById('mot').innerText = data.mot;

            // 2. Imagen
            if(data.img && data.img.length > 50) document.getElementById('live').src = "data:image/jpeg;base64," + data.img;

            // 3. Recomendaci√≥n Actual (Banner limpio)
            let cleanBanner = data.banner.replace(/<[^>]*>?/gm, '');
            document.getElementById('current-rec').innerText = cleanBanner;
            
            // 4. Historial IA (Viene del backend como lista)
            if(data.recs) {
                let html = "";
                data.recs.forEach(r => {
                    html += `<div class="ia-item"><span>ü§ñ RECOMENDACI√ìN</span>${r}</div>`;
                });
                document.getElementById('ia-history').innerHTML = html;
            }

            // 5. Sistema
            document.getElementById('piIP').innerText = data.piIP || '--';
            document.getElementById('stArd').style.color = data.ard ? '#4ade80' : '#ef4444';
            document.getElementById('stArd').innerText = data.ard ? 'ONLINE' : 'OFFLINE';
            document.getElementById('stIA').style.color = data.iaOn ? '#4ade80' : '#ef4444';
            document.getElementById('stIA').innerText = data.iaOn ? 'ONLINE' : 'OFFLINE';
            document.getElementById('clock').innerText = data.ts;

            // üî• 6. GUARDAR EN HISTORIAL LOCAL (Solo si cambia la hora)
            if(data.ts !== lastTimestamp) {
                lastTimestamp = data.ts;
                saveToLocal(data);
            }
        });

        // --- L√ìGICA LOCAL STORAGE ---
        function saveToLocal(data) {
            let hist = JSON.parse(localStorage.getItem('zen_hist') || "[]");
            // Agregar al inicio
            hist.unshift({
                tm: data.ts,
                t: data.t,
                h: data.h,
                n: data.n,
                r: data.r
            });
            // Mantener solo los √∫ltimos 100 registros
            if(hist.length > 100) hist.pop();
            localStorage.setItem('zen_hist', JSON.stringify(hist));
            renderLocalTable();
        }

        function renderLocalTable() {
            let hist = JSON.parse(localStorage.getItem('zen_hist') || "[]");
            let tbody = document.querySelector("#local-table tbody");
            tbody.innerHTML = "";
            hist.forEach(r => {
                let tr = `<tr><td>${r.tm}</td><td>${r.t}¬∞</td><td>${r.h}%</td><td>${r.n}</td><td>${r.r}</td></tr>`;
                tbody.innerHTML += tr;
            });
        }

        function clearLocalHist() {
            if(confirm("¬øBorrar historial local?")) {
                localStorage.removeItem('zen_hist');
                renderLocalTable();
            }
        }
    </script>
</body>
</html>
