<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell치n Cloud | Control Av칤cola RD 游뾇릖</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --green: #22c55e; --warn: #fbbf24; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 20px; }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; max-width: 1300px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #334155; margin-bottom: 20px; }
        #foscam-stream { width: 100%; height: 350px; background: #000; border-radius: 10px; object-fit: contain; border: 2px solid var(--blue); }
        .sensor-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .sensor-box { background: #0f172a; padding: 10px; border-radius: 10px; text-align: center; border-bottom: 3px solid var(--blue); }
        .val { font-size: 1.5rem; font-weight: bold; display: block; }
        .label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; }
        canvas { max-height: 250px; }
        .best-practice { font-size: 0.85rem; color: var(--warn); padding: 10px; border: 1px dashed var(--warn); border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue);">CAPELL츼N CLOUD - GESTI칍N AV칈COLA 游뾇릖</h1>

<div class="grid-container">
    <div>
        <div class="card">
            <img id="foscam-stream" src="" alt="Cargando stream...">
            <p id="v-status" style="font-size:0.8rem">Conectando...</p>
            <div id="recomendacion" class="best-practice">Analizando condiciones...</div>
        </div>

        <div class="sensor-grid">
            <div class="sensor-box"><span class="label">Temperatura</span><span class="val" id="t-val">--춿C</span></div>
            <div class="sensor-box"><span class="label">Humedad</span><span class="val" id="h-val">--%</span></div>
            <div class="sensor-box"><span class="label">NH3 (Amon칤aco)</span><span class="val" id="n-val">-- PPM</span></div>
            <div class="sensor-box"><span class="label">Lluvia</span><span class="val" id="r-val">--</span></div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h3>Evoluci칩n de Temperatura (24h)</h3>
            <canvas id="tempChart"></canvas>
        </div>
    </div>

    <div class="card">
        <h3>HISTORIAL DE DATOS</h3>
        <div id="log-avicola" style="font-size: 0.8rem; line-height: 1.6;"></div>
    </div>
</div>

<script>
    // 1. FIREBASE
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. CONFIGURACI칍N DE GR츼FICA
    const ctx = document.getElementById('tempChart').getContext('2d');
    const tempChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [{ label: 'Temp 춿C', data: [], borderColor: '#3b82f6', tension: 0.3 }] },
        options: { scales: { y: { beginAtZero: false }, x: { display: false } } }
    });

    // 3. VIDEO AUTOM츼TICO
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1200);
        img.onload = () => document.getElementById("v-status").innerHTML = "游댮 EN VIVO";
    };

    // 4. L칍GICA DE SENSORES Y MEJORES PR츼CTICAS RD
    db.ref('galpon/actual').on('value', (snapshot) => {
        const d = snapshot.val();
        if(d) {
            document.getElementById('t-val').innerText = d.temperatura + "춿C";
            document.getElementById('h-val').innerText = d.humedad + "%";
            document.getElementById('n-val').innerText = d.nh3_ppm + " PPM";
            document.getElementById('r-val').innerText = d.lluvia;

            // Actualizar Gr치fica
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            tempChart.data.labels.push(time);
            tempChart.data.datasets[0].data.push(d.temperatura);
            if(tempChart.data.labels.length > 15) { tempChart.data.labels.shift(); tempChart.data.datasets[0].data.shift(); }
            tempChart.update();

            // MEJORES PR츼CTICAS RD (POLLOS DE ENGORDE)
            let consejo = "Condiciones 칩ptimas.";
            if(d.temperatura > 31) consejo = "丘멆잺 ALERTA CALOR: Active ventiladores o nebulizadores (Estr칠s cal칩rico RD).";
            if(d.nh3_ppm > 20) consejo = "丘멆잺 ALERTA AMON칈ACO: Aumente ventilaci칩n lateral para evitar problemas respiratorios.";
            if(d.humedad > 80) consejo = "丘멆잺 HUMEDAD ALTA: Cuidado con la cama mojada. Riesgo de coccidiosis.";
            document.getElementById('recomendacion').innerText = "游눠 PR츼CTICA SUGERIDA: " + consejo;

            // Historial r치pido
            const log = document.getElementById('log-avicola');
            log.innerHTML = `<div>[${time}] T: ${d.temperatura}춿C | H: ${d.humedad}% | NH3: ${d.nh3_ppm}</div>` + log.innerHTML;
        }
    });
</script>
</body>
</html>
