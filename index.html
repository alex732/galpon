<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capell√°n Cloud - Gauges</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    
    <style>
        body { background: #0f172a; color: #f1f5f9; font-family: sans-serif; padding: 15px; text-align: center; margin: 0; }
        .gauges-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px auto; max-width: 900px; background: #1e293b; padding: 20px; border-radius: 20px; }
        .gauge-box { background: #334155; padding: 10px; border-radius: 15px; }
        .status { color: #22c55e; font-size: 0.8rem; margin-bottom: 10px; }
        .rain-card { background: #1e293b; padding: 15px; border-radius: 12px; max-width: 200px; margin: 10px auto; border-top: 4px solid #3b82f6; }
        
        /* Historiales */
        .section-title { text-align: left; max-width: 800px; margin: 20px auto 10px; color: #94a3b8; font-size: 0.9rem; font-weight: bold; border-left: 4px solid #3b82f6; padding-left: 10px; }
        .log-container { background: #1e293b; border-radius: 10px; max-width: 800px; margin: 0 auto 20px; border: 1px solid #334155; overflow: hidden; }
        .log-entry { padding: 10px 15px; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; font-size: 0.85em; text-align: left; }
        .critical { border-left: 5px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        table { width: 100%; max-width: 800px; margin: 0 auto; background: #1e293b; border-radius: 10px; font-size: 0.85rem; border-collapse: collapse; }
        th { background: #334155; color: #94a3b8; padding: 10px; }
        td { padding: 8px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>
    <h2 style="margin: 10px 0;">üõ∞Ô∏è CAPELL√ÅN CLOUD GAUGES</h2>
    <div id="st" class="status">Cargando instrumentos...</div>
    
    <div class="gauges-container">
        <div id="chart_temp" class="gauge-box"></div>
        <div id="chart_hum" class="gauge-box"></div>
        <div id="chart_nh3" class="gauge-box"></div>
    </div>

    <div class="rain-card">LLUVIA: <strong id="l">--</strong></div>

    <div class="section-title">‚ö†Ô∏è Recomendaciones</div>
    <div class="log-container" id="reco-log"><div style="padding:15px">Esperando datos...</div></div>

    <div class="section-title">üìú Historial</div>
    <table>
        <thead><tr><th>Hora</th><th>T</th><th>H</th><th>NH3</th><th>Lluvia</th></tr></thead>
        <tbody id="data-hist"></tbody>
    </table>

    <script>
        // CONFIGURACI√ìN EXACTA DE TU FIREBASE
        const firebaseConfig = { 
            databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" 
        };
        firebase.initializeApp(firebaseConfig);

        google.charts.load('current', {'packages':['gauge']});
        google.charts.setOnLoadCallback(initCharts);

        let chartT, chartH, chartN, dataT, dataH, dataN, optionsT, optionsH, optionsN;
        let lastReco = ""; let logsData = [];

        function initCharts() {
            dataT = google.visualization.arrayToDataTable([['Label', 'Value'],['Temp', 0]]);
            optionsT = { width: 160, height: 160, redFrom: 33, redTo: 50, yellowFrom: 28, yellowTo: 33, minorTicks: 5, max: 50 };
            chartT = new google.visualization.Gauge(document.getElementById('chart_temp'));

            dataH = google.visualization.arrayToDataTable([['Label', 'Value'],['Hum %', 0]]);
            optionsH = { width: 160, height: 160, yellowFrom: 70, yellowTo: 85, redFrom: 85, redTo: 100, minorTicks: 5 };
            chartH = new google.visualization.Gauge(document.getElementById('chart_hum'));

            dataN = google.visualization.arrayToDataTable([['Label', 'Value'],['NH3', 0]]);
            optionsN = { width: 160, height: 160, redFrom: 25, redTo: 100, yellowFrom: 15, yellowTo: 25, minorTicks: 5, max: 100 };
            chartN = new google.visualization.Gauge(document.getElementById('chart_nh3'));

            updateFromFirebase();
        }

        function updateFromFirebase() {
            // AQU√ç ESTABA EL ERROR: Cambiamos a '/galpon/actual'
            firebase.database().ref('/galpon/actual').on('value', (s) => {
                const d = s.val();
                if(d && chartT) {
                    const hora = new Date().toLocaleTimeString();
                    
                    // Actualizar los Gauges con tus datos (T, H, N, L)
                    dataT.setValue(0, 1, d.T); chartT.draw(dataT, optionsT);
                    dataH.setValue(0, 1, d.H); chartH.draw(dataH, optionsH);
                    dataN.setValue(0, 1, d.N); chartN.draw(dataN, optionsN);
                    
                    document.getElementById('l').innerText = d.L;
                    document.getElementById('st').innerText = "VIVO - " + hora;

                    // Historial de Datos
                    logsData.unshift({h:hora, t:d.T, hu:d.H, n:d.N, l:d.L});
                    if(logsData.length > 8) logsData.pop();
                    let htm = "";
                    logsData.forEach(e => { 
                        htm += `<tr><td>${e.h}</td><td>${e.t}¬∞</td><td>${e.hu}%</td><td>${e.n}</td><td>${e.l}</td></tr>`; 
                    });
                    document.getElementById('data-hist').innerHTML = htm;

                    // L√≥gica de Recomendaciones
                    let msg = "";
                    if(d.N > 25) msg = "CR√çTICO: Amon√≠aco alto ("+d.N+"). Ventilar.";
                    else if(d.T > 33) msg = "CALOR: "+d.T+"¬∞C. Activar extractores.";
                    else if(d.L == "SI") msg = "AVISO: Lluvia. Cerrar cortinas.";

                    if(msg !== "" && msg !== lastReco) {
                        const container = document.getElementById('reco-log');
                        if(lastReco === "") container.innerHTML = "";
                        const div = document.createElement('div');
                        div.className = "log-entry critical";
                        div.innerHTML = `<span>${msg}</span><span style="color:#64748b">${hora}</span>`;
                        container.prepend(div);
                        lastReco = msg;
                    }
                }
            });
        }
    </script>
</body>
</html>
