<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Capell√°n Cloud | Dashboard Final</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<!-- GaugeJS -->
<script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>

<style>
:root {
    --bg:#0f172a; --card:#1e293b; --text:#f8fafc;
    --primary:#3b82f6; --safe:#22c55e; --danger:#ef4444;
}
body {
    font-family:'Segoe UI',sans-serif;
    background:var(--bg); color:var(--text);
    margin:0; padding:20px; text-align:center;
}
.grid {
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
    gap:20px; max-width:1200px; margin:auto;
}
.card {
    background:var(--card);
    border-radius:20px;
    padding:25px;
    border:5px solid #334155;
}
.val {
    font-size:3.5rem;
    font-weight:bold;
}

/* Video */
.cam-container {
    width:100%; height:350px;
    border-radius:15px;
    border:3px solid var(--primary);
    background:#000;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
}
#foscam-stream {
    width:100%;
    height:100%;
    object-fit:contain;
    display:none;
}
.btn-auth {
    background:var(--danger);
    color:white;
    border:none;
    padding:15px;
    border-radius:10px;
    cursor:pointer;
    font-weight:bold;
    width:100%;
    margin-bottom:15px;
}
.ptz-btn {
    background:#334155;
    color:white;
    border:none;
    padding:12px;
    border-radius:8px;
    cursor:pointer;
    margin:3px;
    width:55px;
}
</style>
</head>

<body>

<h1 style="color:var(--primary)">CAPELL√ÅN CLOUD üö¶</h1>

<div class="grid">

    <!-- NH3 -->
    <div class="card">
        <h3>AMON√çACO (NH‚ÇÉ)</h3>
        <canvas id="gauge-nh3" width="300" height="300"></canvas>
        <div id="val-nh3" class="val">--</div>
    </div>

    <!-- TEMP -->
    <div class="card">
        <h3>TEMPERATURA</h3>
        <canvas id="gauge-temp" width="300" height="300"></canvas>
        <div id="val-temp" class="val">--</div>
    </div>

    <!-- CAMARA -->
    <div class="card" style="border-color:var(--primary)">
        <button id="btn-play" class="btn-auth" onclick="activarVideo()">
            PASO 1: ACTIVAR VIDEO
        </button>

        <div class="cam-container">
            <img id="foscam-stream">
            <div id="loading-text" style="color:#64748b">
                Esperando c√°mara...
            </div>
        </div>

        <div style="margin-top:15px">
            <button class="ptz-btn" onclick="mover('ptzMoveUp')">‚ñ≤</button><br>
            <button class="ptz-btn" onclick="mover('ptzMoveLeft')">‚óÑ</button>
            <button class="ptz-btn" onclick="mover('ptzReset')">üè†</button>
            <button class="ptz-btn" onclick="mover('ptzMoveRight')">‚ñ∫</button><br>
            <button class="ptz-btn" onclick="mover('ptzMoveDown')">‚ñº</button>
        </div>
    </div>

</div>

<script>
/* ================= CAMARA ================= */
const IP  = "192.168.2.193:88";
const USR = "alex";
const PWD = "F7324088";
const base = `http://${IP}/cgi-bin/CGIProxy.fcgi?usr=${USR}&pwd=${PWD}`;

function activarVideo(){
    window.open(base+"&cmd=getDevState","auth","width=300,height=200");
    setTimeout(()=>{
        const img = document.getElementById("foscam-stream");
        img.src = `${base}&cmd=getLiveStream&type=1&_ts=${Date.now()}`;
        img.style.display="block";
        document.getElementById("loading-text").style.display="none";
        const btn=document.getElementById("btn-play");
        btn.innerText="‚úÖ VIDEO CONECTADO";
        btn.style.background="#22c55e";

        img.onerror=()=>{ 
            img.src = `${base}&cmd=getLiveStream&type=1&_ts=${Date.now()}`;
        };
    },2000);
}
function mover(cmd){ fetch(`${base}&cmd=${cmd}`).catch(()=>{}); }

/* ================= FIREBASE ================= */
firebase.initializeApp({
    databaseURL:"https://galpon-capellan-default-rtdb.firebaseio.com"
});
const db = firebase.database();

/* ================= GAUGES ================= */
const gOpts = {
    angle:-0.2,
    lineWidth:0.2,
    pointer:{length:0.6,color:"#fff"},
    staticZones:[
        {strokeColor:"#22c55e",min:0,max:20},
        {strokeColor:"#ef4444",min:20,max:100}
    ]
};

const gNH3  = new Gauge(document.getElementById("gauge-nh3")).setOptions(gOpts);
const gTemp = new Gauge(document.getElementById("gauge-temp")).setOptions(gOpts);
gNH3.maxValue=100; gTemp.maxValue=50;

function colorVal(el,val,limit){
    el.style.color = val>limit ? "#ef4444" : "#22c55e";
}

db.ref("galpon/actual").on("value",snap=>{
    const d=snap.val();
    if(!d) return;

    if(d.nh3_ppm!=null){
        gNH3.set(d.nh3_ppm);
        const e=document.getElementById("val-nh3");
        e.innerText=d.nh3_ppm+" ppm";
        colorVal(e,d.nh3_ppm,20);
    }

    if(d.temperatura!=null){
        gTemp.set(d.temperatura);
        document.getElementById("val-temp").innerText=d.temperatura+"¬∞C";
    }
});
</script>

</body>
</html>
