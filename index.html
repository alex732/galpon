<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZENTINEL CLOUD v267</title>
    <style>
        /* DISE√ëO MAESTRO v239 INTACTO */
        body { background: #0f172a; color: #f8fafc; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #334155; padding-bottom: 5px; }
        .header-title { font-size: 20px; font-weight: 800; }
        .header-clock { color: #94a3b8; font-family: monospace; }
        
        .layout-grid { display: grid; grid-template-columns: 180px 1fr 280px; gap: 10px; }
        
        /* FIX PRESETS: 65px ALTO */
        .matrix-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; margin-top: 5px; width: 100%; border: 2px solid #334155; box-sizing: border-box; }
        .cam-cell { background: #000; height: 65px; position: relative; border: 0.5px solid #1e293b; overflow: hidden; cursor: pointer; transition: 0.2s; }
        .cam-cell:hover { z-index: 10; transform: scale(1.2); border: 1px solid #38bdf8; }
        .cam-tag { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); font-size: 7px; text-align: center; color: white; padding: 1px; }
        .cam-cell img { width: 100%; height: 100%; object-fit: cover; }

        .card { background: #1e293b; border: 1px solid #334155; border-radius: 6px; padding: 8px; margin-bottom: 8px; }
        .card-title { font-size: 10px; color: #38bdf8; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px solid #334155; }
        
        /* RELOJES REDONDOS */
        .gauge-box { background: #0f172a; border-radius: 50%; width: 100px; height: 100px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 5px auto; border: 4px solid #334155; transition: 0.5s; }
        .g-green { border-color: #22c55e; color: #4ade80; }
        .g-red { border-color: #ef4444; color: #f87171; }
        .val-text { font-size: 22px; font-weight: bold; }
        .lbl-text { font-size: 8px; color: #94a3b8; }

        .video-main { width: 100%; height: 380px; background: #000; border-radius: 6px; object-fit: cover; border: 1px solid #334155; }
        
        /* BOX CLIMA CLICKABLE */
        .pred-box { background: #0f172a; border-left: 4px solid #38bdf8; padding: 8px; font-size: 11px; color: #e2e8f0; margin-top: 10px; min-height: 80px; border-radius: 4px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .w-thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #334155; }
        .w-text { flex: 1; }

        .banner-neutral { background: #1e293b; color: #94a3b8; padding: 10px; border-radius: 4px; font-weight: bold; text-align: center; border: 1px solid #334155; margin-bottom: 10px; }
        .banner-safe { background: #064e3b; color: #34d399; padding: 10px; border-radius: 4px; font-weight: bold; text-align: center; border: 1px solid #059669; margin-bottom: 10px; }
        .banner-danger { background: #450a0a; color: #f87171; padding: 10px; border-radius: 4px; font-weight: bold; text-align: center; border: 1px solid #ef4444; animation: blink 1s infinite; margin-bottom: 10px; }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* FIX ESTADO: gap 8px */
        .pi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .stat-box { background: #0f172a; padding: 8px 4px; border-radius: 3px; text-align: center; border: 1px solid #334155; font-size: 9px; }
        .stat-val { color: #38bdf8; font-weight: bold; display: block; }

        /* HISTORIAL */
        table { width: 100%; border-collapse: collapse; font-size: 10px; }
        th { text-align: left; color: #38bdf8; border-bottom: 1px solid #334155; padding: 4px; }
        td { padding: 4px; border-bottom: 1px solid #33415555; }

        /* MODALES */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .modal-content { max-width: 90%; border: 2px solid #38bdf8; border-radius: 8px; width: 800px; background: #1e293b; padding: 20px; }
        .close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="weatherModal" class="modal" onclick="this.style.display='none'">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close" onclick="document.getElementById('weatherModal').style.display='none'">&times;</span>
            <h2 style="color:#38bdf8;margin-top:0">üõ∞Ô∏è AN√ÅLISIS CLIM√ÅTICO IA</h2>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <img id="w-img-large" style="width:100%;border-radius:8px;">
                <div>
                    <div id="w-info-large" style="font-size:16px;line-height:1.5;"></div>
                    <div id="w-stats-large" style="margin-top:15px;padding:10px;background:#0f172a;color:#4ade80;font-family:monospace;font-size:20px;border-radius:5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-bar">
        <div class="header-title">ZENTINEL <span style="color:#38bdf8">CLOUD</span></div>
        <div id="clock" class="header-clock">00:00:00</div>
    </div>

    <div class="layout-grid">
        <div class="col-left">
            <div class="card">
                <div class="card-title">SENSORES</div>
                <div id="bgT" class="gauge-box"><span id="vT" class="val-text">--</span><span class="lbl-text">TEMP</span></div>
                <div id="bgH" class="gauge-box"><span id="vH" class="val-text">--</span><span class="lbl-text">HUM</span></div>
                <div id="bgN" class="gauge-box"><span id="vN" class="val-text">--</span><span class="lbl-text">NH3</span></div>
                <div id="bgR" class="gauge-box"><span id="vR" style="font-size:30px;">‚òÄÔ∏è</span><span id="lR" class="lbl-text">SECO</span></div>
                <div class="card-title" style="margin-top:15px">CLIMA (CLIC)</div>
                <div class="pred-box" onclick="expandWeather()">
                    <img id="w-img" class="w-thumb">
                    <div id="wp" class="w-text">Cargando...</div>
                </div>
            </div>
        </div>

        <div class="col-center">
            <div id="banner-ia" class="banner-neutral">Sincronizando Zentinel...</div>
            <img id="live-img" class="video-main">
            <div id="matrix" class="matrix-grid"></div>
            <div class="card" style="margin-top:10px">
                <div class="card-title">HISTORIAL DE MEDICIONES</div>
                <table id="hist-table">
                    <thead><tr><th>HORA</th><th>T¬∞</th><th>H%</th><th>NH3</th><th>LLUVIA</th></tr></thead>
                    <tbody id="t-body"></tbody>
                </table>
            </div>
        </div>

        <div class="col-right">
            <div class="card">
                <div class="card-title">ESTADO DEL SISTEMA</div>
                <div class="pi-grid">
                    <div class="stat-box"><span id="stIP" class="stat-val">--</span>IP</div>
                    <div class="stat-box"><span id="stCPU" class="stat-val">--</span>CPU</div>
                    <div class="stat-box"><span id="stRAM" class="stat-val">--</span>RAM</div>
                    <div class="stat-box"><span id="stIA" class="stat-val">--</span>IA</div>
                    <div class="stat-box"><span id="stARD" class="stat-val">--</span>ARD</div>
                    <div class="stat-box"><span id="stMOT" class="stat-val">--</span>MOT</div>
                </div>
            </div>
            <div class="card">
                <div class="card-title">RADAR METEOROL√ìGICO</div>
                <iframe width="100%" height="200" src="https://radar-met2.sna.gob.do/" frameborder="0" style="border-radius:4px;"></iframe>
            </div>
            <div class="card">
                <div class="card-title">VIENTO (WINDY)</div>
                <iframe width="100%" height="150" src="https://embed.windy.com/embed2.html?lat=19.7&lon=-70.7&zoom=7&overlay=wind" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <script>
        const FB_URL = "https://zentinel-ia-default-rtdb.firebaseio.com/zentinel.json";
        let lastData = null;

        function setG(id, v, max) {
            let el = document.getElementById('v' + id);
            let bg = document.getElementById('bg' + id);
            el.innerText = v;
            bg.className = 'gauge-box ' + (parseFloat(v) > max ? 'g-red' : 'g-green');
        }

        function expandWeather() {
            if(!lastData) return;
            document.getElementById('weatherModal').style.display = 'flex';
            document.getElementById('w-img-large').src = "data:image/jpeg;base64," + lastData.w_img;
            document.getElementById('w-info-large').innerText = lastData.weather;
            document.getElementById('w-stats-large').innerText = `T: ${lastData.t}¬∞C | H: ${lastData.h}%`;
        }

        async function update() {
            try {
                const r = await fetch(FB_URL);
                const d = await r.json();
                lastData = d;

                // Sensores
                setG('T', d.t, 30); setG('H', d.h, 75); setG('N', d.n, 20);
                document.getElementById('vR').innerText = d.r == 'SI' ? '‚õàÔ∏è' : '‚òÄÔ∏è';
                document.getElementById('lR').innerText = d.r == 'SI' ? 'LLUVIA' : 'SECO';

                // Video y Clima
                document.getElementById('live-img').src = "data:image/jpeg;base64," + d.img;
                document.getElementById('w-img').src = "data:image/jpeg;base64," + d.w_img;
                document.getElementById('wp').innerText = d.weather;

                // Banner
                const b = document.getElementById('banner-ia');
                b.innerHTML = d.banner;
                b.className = d.banner.includes('danger') ? 'banner-danger' : (d.banner.includes('safe') ? 'banner-safe' : 'banner-neutral');

                // Estado Sistema
                document.getElementById('stIP').innerText = "R-Pi";
                document.getElementById('stMOT').innerText = d.mot;
                document.getElementById('stIA').innerText = "ON";

                // Matriz
                let mHtml = '';
                for(let y=0; y<4; y++) {
                    for(let x=0; x<6; x++) {
                        let id = `F${y}_C${x}`;
                        let color = d.matrix ? (d.matrix[id] || '#1e293b') : '#1e293b';
                        let thumb = d.presets ? (d.presets[id] || '') : '';
                        mHtml += `<div class="cam-cell" style="border-color:${color}">
                                    ${thumb ? `<img src="data:image/jpeg;base64,${thumb}">` : ''}
                                    <div class="cam-tag">${id}</div>
                                  </div>`;
                    }
                }
                document.getElementById('matrix').innerHTML = mHtml;

                document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            } catch(e) { console.error(e); }
        }

        setInterval(update, 3000);
        update();
    </script>
</body>
</html>
