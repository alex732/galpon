<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZENTINEL REMOTE v258 | PUERTO PLATA</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { background: #0b1120; color: #f8fafc; font-family: sans-serif; margin: 0; overflow-y: auto; }
        .header { background: #020617; border-bottom: 2px solid #1e293b; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:100; }
        .brand { font-size: 18px; font-weight: 900; color: #38bdf8; letter-spacing: 1px; }
        .layout { display: grid; grid-template-columns: 180px 1fr 300px; gap: 10px; padding: 10px; }
        .col { display: flex; flex-direction: column; gap: 10px; }
        .card { background: #111827; border: 1px solid #1e293b; border-radius: 4px; padding: 10px; }
        .card-h { font-size: 10px; color: #38bdf8; font-weight: 800; border-bottom: 1px solid #1e293b; margin-bottom: 10px; text-transform: uppercase; }
        
        /* GAUGES v258 */
        .gauge-box { background: #020617; border-radius: 50%; width: 85px; height: 85px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin: 0 auto 10px; border: 3px solid #22c55e; }
        .v-val { font-size: 18px; font-weight: bold; } .v-lbl { font-size: 8px; color: #94a3b8; }
        .g-red { border-color: #ef4444; }

        /* MATRIX & SNAPSHOTS */
        .live-snap { width: 100%; height: 320px; background: #000; border-radius: 4px; object-fit: cover; border: 2px solid #334155; }
        .matrix { display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; margin-top: 10px; }
        .cell { height: 40px; background: #000; border: 1px solid #1e293b; position: relative; border-radius: 2px; cursor: pointer; overflow: hidden; }
        .cell img { width: 100%; height: 100%; object-fit: cover; opacity: 0.8; transition: 0.2s; }
        .cell img:hover { opacity: 1; transform: scale(1.1); }
        .cell-tag { position: absolute; bottom: 0; width: 100%; font-size: 6px; background: rgba(0,0,0,0.8); text-align: center; color: #38bdf8; }

        /* MODAL VISOR */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal img { max-width: 90%; max-height: 80%; border: 2px solid #38bdf8; border-radius: 8px; }
        .close-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: #ef4444; color: #fff; cursor: pointer; border-radius: 4px; font-weight: bold; }

        .sys-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .sys-item { background: #020617; padding: 5px; text-align: center; font-size: 9px; border: 1px solid #1e293b; }
        .sys-val { display: block; color: #38bdf8; font-weight: bold; }
    </style>
</head>
<body>

<div id="modal" class="modal" onclick="this.style.display='none'">
    <div class="close-btn">CERRAR</div>
    <img id="modal-img" src="">
</div>

<div class="header">
    <div class="brand">ZENTINEL REMOTE v258</div>
    <div id="topDate" style="font-family:monospace; color:#94a3b8">--/--/-- --:--:--</div>
</div>

<div class="layout">
    <div class="col">
        <div class="card">
            <div class="card-h">Sensores</div>
            <div class="gauge-box" id="bgT"><span id="vT" class="v-val">--</span><span class="v-lbl">TEMP</span></div>
            <div class="gauge-box" id="bgH"><span id="vH" class="v-val">--</span><span class="v-lbl">HUM</span></div>
            <div class="gauge-box" id="bgN"><span id="vN" class="v-val">--</span><span class="v-lbl">NH3</span></div>
            <div class="card" style="text-align:center; padding:5px;"><span id="vR" style="font-size:25px">☀️</span></div>
        </div>
        <div class="card"><div class="card-h">Satélite NOAA</div><img src="https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/car/GEOCOLOR/latest.jpg" style="width:100%"></div>
        <div class="card"><div class="card-h">IA Clima</div><div id="w-pred" style="font-size:9px; font-family:monospace">Analizando...</div></div>
    </div>

    <div class="col">
        <div id="banner" style="background:#064e3b; padding:10px; text-align:center; font-weight:bold; border-radius:4px; margin-bottom:10px; font-size:12px; border:1px solid #10b981">ONLINE</div>
        <img id="live-snap" class="live-snap" src="">
        <div id="matrix" class="matrix"></div>
        <div class="card"><div class="card-h">Terminal Remoto</div><div id="chat" style="height:100px; background:#020617; border:1px solid #38bdf8; padding:5px; font-size:10px; overflow-y:auto"></div></div>
    </div>

    <div class="col">
        <div class="card">
            <div class="card-h">Sistema & Red</div>
            <div class="sys-grid">
                <div class="sys-item"><span id="cpu" class="sys-val">--</span>CPU</div>
                <div class="sys-item"><span id="ram" class="sys-val">--</span>RAM</div>
                <div class="sys-item"><span id="dsk" class="sys-val">--</span>DSK</div>
            </div>
            <div class="sys-grid" style="margin-top:5px">
                <div class="sys-item">IA: <span id="s-ia">--</span></div>
                <div class="sys-item">ARD: <span id="s-ard">--</span></div>
                <div class="sys-item">MOT: <span id="s-mot">--</span></div>
            </div>
        </div>
        <div class="card"><div class="card-h">Alertas IA</div><div id="ia-log" style="height:150px; overflow-y:auto; font-size:10px; color:#f87171; font-family:monospace"></div></div>
        <div class="card"><div class="card-h">Radar RD</div><iframe style="width:100%; height:130px; border:0;" src="https://radar-met2.sna.gob.do/"></iframe></div>
        <div class="card"><div class="card-h">Windy PP</div><iframe style="width:100%; height:130px; border:0;" src="https://embed.windy.com/embed2.html?lat=19.7253&lon=-70.7397&zoom=11"></iframe></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://zentinel-ia-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Init Matrix
    const matrixEl = document.getElementById('matrix');
    for(let y=0; y<4; y++){
        for(let x=0; x<6; x++){
            let id = `F${y}_C${x}`;
            matrixEl.innerHTML += `<div class="cell" id="d_${id}" onclick="openModal('${id}')"><img id="img_${id}" src=""><div class="cell-tag">${id}</div></div>`;
        }
    }

    db.ref('zentinel').on('value', s => {
        const d = s.val(); if(!d) return;
        document.getElementById('vT').innerText = d.t + "°";
        document.getElementById('vH').innerText = d.h + "%";
        document.getElementById('vN').innerText = d.n;
        document.getElementById('vR').innerText = d.r === "SI" ? "⛈️" : "☀️";
        document.getElementById('bgT').className = "gauge-box " + (parseFloat(d.t)>32 ? "g-red" : "");
        document.getElementById('topDate').innerText = d.ts;
        document.getElementById('banner').innerText = d.ia;
        document.getElementById('cpu').innerText = d.cpu;
        document.getElementById('ram').innerText = d.ram;
        document.getElementById('dsk').innerText = d.disk;
        document.getElementById('s-ia').innerText = "ON";
        document.getElementById('s-ard').innerText = "ON";
        document.getElementById('s-mot').innerText = d.motor || "IDLE";
        document.getElementById('w-pred').innerText = d.weather || "Estable";
    });

    db.ref('zentinel/matrix').on('child_added', snap => updateCell(snap));
    db.ref('zentinel/matrix').on('child_changed', snap => updateCell(snap));

    function updateCell(snap) {
        const id = snap.key; const data = snap.val();
        const imgEl = document.getElementById(`img_${id}`);
        if(imgEl && data.img) {
            const src = "data:image/jpeg;base64," + data.img;
            imgEl.src = src;
            document.getElementById('live-snap').src = src; // Foto central = última capturada
            let col = "#1e293b";
            if(data.state === "ALERT") col = "#ef4444";
            if(data.state === "SAFE") col = "#22c55e";
            if(data.state === "SCAN") col = "#3b82f6";
            document.getElementById(`d_${id}`).style.borderColor = col;
        }
    }

    function openModal(id) {
        const src = document.getElementById(`img_${id}`).src;
        if(!src || src === "") return;
        document.getElementById('modal-img').src = src;
        document.getElementById('modal').style.display = "flex";
    }
</script>
</body>
</html>
