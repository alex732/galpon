<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud | Control Maestro</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --primary: #3b82f6; --safe: #22c55e; --danger: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; margin: 0; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 4px solid #334155; text-align: center; }
        .status-safe { border-color: var(--safe); }
        .status-danger { border-color: var(--danger); }
        .val { font-size: 3rem; font-weight: bold; margin: 10px 0; }
        .cam-frame { width: 100%; border-radius: 10px; border: 2px solid var(--primary); background: #000; min-height: 240px; }
        .ptz-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
        button { background: #334155; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        button:hover { background: var(--primary); }
        .btn-sync { background: var(--danger); width: 100%; padding: 15px; margin-bottom: 20px; font-size: 1.1rem; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; border-bottom: 1px solid #334155; text-align: center; }
    </style>
</head>
<body>

    <h1 style="text-align:center;">CAPELL√ÅN CLOUD üö¶</h1>
    
    <div style="max-width: 1200px; margin: auto;">
        <button class="btn-sync" onclick="sincronizar()">‚ö†Ô∏è CLIC AQU√ç PARA ACTIVAR EL VIDEO (IP .97)</button>
    </div>

    <div class="grid">
        <div id="card-nh3" class="card">
            <h3>AMON√çACO (NH3)</h3>
            <canvas id="gauge-nh3"></canvas>
            <div id="val-nh3" class="val">--</div>
            <div id="label-nh3">Iniciando...</div>
        </div>

        <div id="card-temp" class="card">
            <h3>TEMPERATURA</h3>
            <canvas id="gauge-temp"></canvas>
            <div id="val-temp" class="val">--</div>
            <div id="label-temp">Iniciando...</div>
        </div>

        <div class="card" style="border-color: var(--primary);">
            <h3>CONTROL C√ÅMARA PTZ</h3>
            <img id="stream" src="" class="cam-frame">
            <div class="ptz-grid">
                <button onclick="mover('ptzMoveUp')">‚ñ≤</button>
                <button onclick="mover('ptzMoveDown')">‚ñº</button>
                <button onclick="mover('ptzMoveLeft')">‚óÑ</button>
                <button onclick="mover('ptzMoveRight')">‚ñ∫</button>
                <button onclick="mover('ptzReset')">üè†</button>
                <button onclick="tomarFoto()">üì∏</button>
            </div>
        </div>
    </div>

    <div style="max-width: 1200px; margin: 30px auto; background: var(--card); padding: 20px; border-radius: 15px;">
        <h3>HISTORIAL RECIENTE</h3>
        <table>
            <thead><tr><th>Hora</th><th>NH3</th><th>Temp</th><th>Hum</th><th>Lluvia</th></tr></thead>
            <tbody id="history-body"></tbody>
        </table>
    </div>

    <script>
        const IP = "192.168.2.97:88";
        const USR = "alex";
        const PWD = "7324088";
        const base = `http://${IP}/cgi-bin/CGIProxy.fcgi?usr=${USR}&pwd=${PWD}`;

        // 1. FUNCI√ìN M√ÅGICA PARA DESBLOQUEAR
        function sincronizar() {
            // Esto abre una ventana peque√±a para que el navegador "acepte" la IP de la c√°mara
            const win = window.open(`${base}&cmd=getDevState`, "CamSync", "width=200,height=200");
            setTimeout(() => { 
                win.close(); 
                document.getElementById('stream').src = `${base}&cmd=getLiveStream`;
                alert("Sincronizaci√≥n completada. El video deber√≠a aparecer.");
            }, 3000);
        }

        function mover(cmd) { fetch(`${base}&cmd=${cmd}`); }
        function tomarFoto() { window.open(`${base}&cmd=snapShot`, '_blank'); }

        window.onload = function() {
            firebase.initializeApp({ databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" });
            const db = firebase.database();

            const gOpts = { angle: -0.2, lineWidth: 0.2, pointer: { length: 0.6, color: '#FFF' }, staticZones: [{strokeColor: "#22c55e", min: 0, max: 20}, {strokeColor: "#ef4444", min: 20, max: 100}] };
            const gNH3 = new Gauge(document.getElementById('gauge-nh3')).setOptions(gOpts); gNH3.maxValue = 100;
            const gTemp = new Gauge(document.getElementById('gauge-temp')).setOptions(gOpts); gTemp.maxValue = 50;

            db.ref('galpon/actual').on('value', (snap) => {
                const d = snap.val();
                if(d) {
                    gNH3.set(d.nh3_ppm); document.getElementById('val-nh3').innerText = d.nh3_ppm;
                    gTemp.set(d.temperatura); document.getElementById('val-temp').innerText = d.temperatura + "¬∞C";
                    
                    const cNH3 = document.getElementById('card-nh3');
                    cNH3.className = d.nh3_ppm > 20 ? 'card status-danger' : 'card status-safe';
                    
                    const row = `<tr><td>${new Date().toLocaleTimeString()}</td><td>${d.nh3_ppm}</td><td>${d.temperatura}¬∞C</td><td>${d.humedad}%</td><td>${d.lluvia}</td></tr>`;
                    document.getElementById('history-body').insertAdjacentHTML('afterbegin', row);
                    if (document.getElementById('history-body').rows.length > 10) document.getElementById('history-body').deleteRow(10);
                }
            });
        };
    </script>
</body>
</html>
