<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud v7.0 | Historial Permanente</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0f1d; --card: #161e31; --blue: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; transition: 0.3s; }
        body.panic-mode { animation: panic 1s infinite; }
        @keyframes panic { 0% { background: #0a0f1d; } 50% { background: #450a0a; } 100% { background: #0a0f1d; } }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2.5fr 1fr; gap: 20px; max-width: 1600px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d3748; }
        .video-box { position: relative; background: #000; border-radius: 12px; height: 380px; overflow: hidden; border: 2px solid var(--blue); }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; }
        .gauges-wrapper { display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; border-radius: 10px; padding: 10px; }
        .chart-container { grid-column: span 3; height: 350px; margin-top: 10px; }
        .log-box { height: 200px; overflow-y: auto; background: #000; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 10px; font-size: 0.8rem; margin-top: 10px; }
        button { background: var(--blue); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue);">CAPELL√ÅN CLOUD - INTELIGENCIA AV√çCOLA üá©üá¥</h1>

<div class="dashboard-grid">
    <div class="card">
        <h3>LOTE ACTUAL</h3>
        <div style="font-size: 3rem; color: var(--success); text-align: center;" id="dias-lote">0</div>
        <div style="text-align:center;">D√çAS DE EDAD</div>
        <hr style="opacity:0.1; margin:15px 0;">
        <div id="target-temp" style="color: #f59e0b; text-align: center;">Temp. Ideal: --¬∞C</div>
        <button onclick="reiniciarLote()" style="margin-top:10px;">Nuevo Lote</button>
        <div id="rain-val" style="font-size: 1.5rem; text-align: center; margin-top:15px;">--</div>
    </div>

    <div class="card video-box">
        <div style="position:absolute; top:10px; left:10px; background:red; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:bold;">LIVE</div>
        <img id="foscam-stream" src="" alt="Cargando video...">
    </div>

    <div class="card">
        <h3 style="text-align:center;">MONITOREO</h3>
        <div class="gauges-wrapper">
            <div id="g_t"></div>
            <div id="g_h"></div>
            <div id="g_n"></div>
        </div>
    </div>

    <div class="card chart-container">
        <h3>üìà TENDENCIAS (HISTORIAL DE FIREBASE)</h3>
        <canvas id="historialChart"></canvas>
    </div>

    <div class="card" style="grid-column: span 3;">
        <h3>üìú REGISTRO DE EVENTOS RECIENTES</h3>
        <div id="log-display" class="log-box"></div>
    </div>
</div>

<script>
    // 1. FIREBASE
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. VIDEO AUTOM√ÅTICO
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1000);
    };

    // 3. CONFIGURACI√ìN DE GR√ÅFICA
    const ctx = document.getElementById('historialChart').getContext('2d');
    const mainChart = new Chart(ctx, {
        type: 'line',
        data: { labels: [], datasets: [
            { label: 'Temp ¬∞C', borderColor: '#3b82f6', data: [], yAxisID: 'y' },
            { label: 'NH3 PPM', borderColor: '#ef4444', data: [], yAxisID: 'y1' }
        ]},
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', grid: {color:'#334155'} },
                y1: { type: 'linear', position: 'right', grid: {display:false} }
            },
            plugins: { legend: { labels: { color: 'white' } } }
        }
    });

    // 4. GAUGES Y L√ìGICA PERMANENTE
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(() => {
        let datT = google.visualization.arrayToDataTable([['Label', 'Value'], ['Temp', 0]]);
        let datH = google.visualization.arrayToDataTable([['Label', 'Value'], ['Hum', 0]]);
        let datN = google.visualization.arrayToDataTable([['Label', 'Value'], ['NH3', 0]]);
        let chT = new google.visualization.Gauge(document.getElementById('g_t'));
        let chH = new google.visualization.Gauge(document.getElementById('g_h'));
        let chN = new google.visualization.Gauge(document.getElementById('g_n'));
        let opts = { width: 180, height: 180, redFrom: 32, redTo: 45, yellowFrom: 29, yellowTo: 32, greenFrom: 20, greenTo: 29, max: 45 };

        // CARGAR HISTORIAL AL ABRIR
        db.ref('galpon/historial').limitToLast(30).once('value', (snap) => {
            snap.forEach((child) => {
                const v = child.val();
                mainChart.data.labels.push(v.hora);
                mainChart.data.datasets[0].data.push(v.temp);
                mainChart.data.datasets[1].data.push(v.nh3);
            });
            mainChart.update();
        });

        let ultimaGrabacion = 0;

        // ESCUCHAR DATOS EN VIVO
        db.ref('galpon/actual').on('value', (snap) => {
            const d = snap.val();
            if(d) {
                datT.setValue(0, 1, d.temperatura); chT.draw(datT, opts);
                datH.setValue(0, 1, d.humedad); chH.draw(datH, {...opts, redFrom:80, max:100});
                datN.setValue(0, 1, d.nh3_ppm); chN.draw(datN, {...opts, redFrom:20, max:50});
                
                document.getElementById('rain-val').innerText = d.lluvia === "SI" ? "üåßÔ∏è LLUEVE" : "‚òÄÔ∏è SECO";

                // GUARDADO PERMANENTE (CADA 15 MINUTOS)
                const ahora = Date.now();
                if(ahora - ultimaGrabacion > 900000) { 
                    const horaActual = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    db.ref('galpon/historial').push({ hora: horaActual, temp: d.temperatura, nh3: d.nh3_ppm });
                    ultimaGrabacion = ahora;
                    
                    // Actualizar gr√°fica en vivo
                    mainChart.data.labels.push(horaActual);
                    mainChart.data.datasets[0].data.push(d.temperatura);
                    mainChart.data.datasets[1].data.push(d.nh3_ppm);
                    if(mainChart.data.labels.length > 30) { mainChart.data.labels.shift(); mainChart.data.datasets[0].data.shift(); mainChart.data.datasets[1].data.shift(); }
                    mainChart.update();
                }

                updateDashboardLogic(d);
            }
        });
    });

    function updateDashboardLogic(d) {
        const start = new Date(localStorage.getItem('batchStart') || new Date());
        const days = Math.floor((new Date() - start) / (1000*60*60*24));
        document.getElementById('dias-lote').innerText = days;

        if(d.temperatura > 33) document.body.classList.add('panic-mode');
        else document.body.classList.remove('panic-mode');

        const log = document.getElementById('log-display');
        log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] T:${d.temperatura}¬∞ | NH3:${d.nh3_ppm}</div>` + log.innerHTML;
    }

    function reiniciarLote() {
        const d = prompt("Fecha inicio (AAAA-MM-DD):");
        if(d) { localStorage.setItem('batchStart', new Date(d).toISOString()); location.reload(); }
    }
</script>
</body>
</html>
