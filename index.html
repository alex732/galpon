import java.net.*;
import java.io.*;
import java.util.*;
import java.util.concurrent.*;
import com.sun.net.httpserver.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.nio.file.*;
import java.util.Base64;
import java.util.regex.*;

/**
 * ü¶Ö ZENTINEL CORE (LITE v1.1 - CLOUD SYNC)
 * - Gestiona Sensores y C√°mara.
 * - Conecta con Bridge IA (Local).
 * - Sube datos a Firebase para el Dashboard en GitHub.
 */
public class ZentinelCore {
    // ================= CONFIGURACI√ìN DE USUARIO =================
    // 1. TU FIREBASE (Crea una Realtime DB en modo prueba/p√∫blico)
    // El enlace debe terminar en '/'
    private static final String FIREBASE_URL = "https://TU-PROYECTO-DEFAULT-RTDB.firebaseio.com/"; 
    
    // 2. TUS IPs LOCALES
    private static final String IP_BRIDGE_IA = "192.168.1.100"; // Tu PC Dell
    private static final String IP_CAMARA    = "192.168.1.101"; // Tu C√°mara
    private static final String USR_CAM      = "admin";
    private static final String PWD_CAM      = "123456";
    
    // 3. CONFIGURACI√ìN GEOGR√ÅFICA (Para NOAA)
    private static final String LAT          = "19.79";
    private static final String LON          = "-70.68";
    private static final String UBICACION    = "Puerto Plata";
    // ============================================================

    private static final String URL_BRIDGE = "http://" + IP_BRIDGE_IA + ":8888/process";
    private static final String URL_NOAA   = "https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/car/GEOCOLOR/1000x1000.jpg";
    private static final String URL_API    = "https://api.open-meteo.com/v1/forecast?latitude="+LAT+"&longitude="+LON+"&current=temperature_2m,precipitation,weather_code&timezone=auto";

    // Variables Vol√°tiles
    private static volatile String iaBannerHTML = "‚òÅÔ∏è INICIANDO SISTEMA...";
    private static volatile String weatherPred = "Cargando...";
    private static volatile byte[] liveFrame = new byte[0];
    private static volatile byte[] snapshotFrame = new byte[0];
    private static volatile String lastT="0", lastH="0", lastN="0", lastR="NO";
    
    // Control
    private static final Object frameLock = new Object();
    private static volatile boolean iaServerOnline = false;
    private static volatile boolean iaOcupada = false;
    private static final List<String> logList = new CopyOnWriteArrayList<>();

    public static void main(String[] args) {
        log("BOOT", "Zentinel Lite v1.1 (Cloud Enabled)");

        // 1. Hilo Sensores (UDP)
        new Thread(() -> { 
            try(DatagramSocket s = new DatagramSocket(5000)){ 
                byte[] b=new byte[1024]; 
                while(true){ 
                    DatagramPacket p=new DatagramPacket(b,b.length); s.receive(p); 
                    parseSensor(new String(p.getData(),0,p.getLength()).trim()); 
                } 
            }catch(Exception e){ log("UDP", "Modo Simulaci√≥n (Sin Arduino)"); } 
        }).start();

        // 2. Hilo Watchdog & Stats
        new Thread(() -> { while(true) { checkBridge(); try{Thread.sleep(5000);}catch(Exception e){} } }).start();
        
        // 3. Hilo Clima (15 min)
        new Thread(() -> { while(true) { try { if(iaServerOnline) checkWeather(); Thread.sleep(900000); } catch(Exception e){} } }).start();
        
        // 4. üî• HILO FIREBASE (Sube datos a la nube cada 3s)
        new Thread(() -> { while(true) { subirAFirebase(); try{Thread.sleep(3000);}catch(Exception e){} } }).start();

        // Motores
        ejecutarMotorMatricial(); 
        videoEngine(); 
        iniciarServidorLocal(9090);
    }

    // --- SINCRONIZACI√ìN NUBE (FIREBASE) ---
    private static void subirAFirebase() {
        try {
            // Preparamos la imagen (Base64)
            String img64 = "";
            synchronized(frameLock) { if(liveFrame.length > 0) img64 = Base64.getEncoder().encodeToString(liveFrame); }
            
            // Construimos JSON manual (Sin librer√≠as externas para ser Lite)
            // IMPORTANTE: Reemplazar comillas dobles en textos por simples para no romper el JSON
            String json = String.format(
                "{" +
                "\"ts\":\"%s\"," +
                "\"t\":\"%s\",\"h\":\"%s\",\"n\":\"%s\",\"r\":\"%s\"," +
                "\"banner\":\"%s\"," +
                "\"weather\":\"%s\"," +
                "\"cam_img\":\"%s\"," +
                "\"ia_status\":%b" +
                "}",
                LocalDateTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")),
                lastT, lastH, lastN, lastR,
                iaBannerHTML.replace("\"", "'"),
                weatherPred.replace("\"", "'"),
                img64,
                iaServerOnline
            );

            // PUT a Firebase (Sobrescribe zentinel.json)
            URL url = new URL(FIREBASE_URL + "zentinel.json");
            HttpURLConnection con = (HttpURLConnection) url.openConnection();
            con.setRequestMethod("PUT");
            con.setDoOutput(true);
            con.setConnectTimeout(3000);
            try(OutputStream os = con.getOutputStream()) { os.write(json.getBytes("UTF-8")); }
            con.getInputStream().close(); // Ejecutar petici√≥n
            
        } catch (Exception e) { 
            // Silencioso para no llenar logs si no hay internet
        }
    }

    // --- L√ìGICA IA ---
    private static void checkWeather() {
        try {
            byte[] map = download(URL_NOAA);
            String data = downloadTxt(URL_API);
            if(map.length > 0) {
                String r = callBridge(map, "Meteor√≥logo. Ubicaci√≥n: "+UBICACION+". API: "+data+". ¬øLluvia inminente? S√ç/NO y breve raz√≥n.");
                if(!r.startsWith("Error")) { weatherPred = "üõ∞Ô∏è " + r; log("CLIMA", "Actualizado"); }
            }
        } catch(Exception e){}
    }

    private static void procesarFrame(String zona) {
        byte[] f; synchronized(frameLock){ f = snapshotFrame.clone(); }
        if(f.length > 0 && iaServerOnline && !iaOcupada) {
            new Thread(() -> {
                iaOcupada=true;
                log("IA", "Analizando " + zona);
                String r = callBridge(f, "Veterinario. Zona "+zona+". ¬øPollos muertos o sangre? Si borroso di OK. Breve.");
                
                if(r.toUpperCase().contains("ALERTA") || r.toUpperCase().contains("MUERTO")) {
                    iaBannerHTML = "<div class='alert-danger'>üö® " + zona + ": " + r + "</div>";
                } else if (!r.startsWith("Error")) {
                    iaBannerHTML = "<div class='alert-safe'>‚úÖ " + zona + ": " + r + "</div>";
                }
                iaOcupada=false;
            }).start();
        }
    }

    private static String callBridge(byte[] img, String prompt) {
        try {
            String b64 = Base64.getEncoder().encodeToString(img);
            String json = "{\"prompt\":\""+prompt+"\",\"image\":\""+b64+"\"}";
            URL u = new URL(URL_BRIDGE);
            HttpURLConnection c = (HttpURLConnection) u.openConnection();
            c.setRequestMethod("POST"); c.setDoOutput(true); c.setReadTimeout(120000);
            try(OutputStream os = c.getOutputStream()){ os.write(json.getBytes("UTF-8")); }
            try(BufferedReader br = new BufferedReader(new InputStreamReader(c.getInputStream(),"UTF-8"))){ return br.readLine(); }
        } catch(Exception e) { return "Error Bridge"; }
    }

    // --- UTILS & MOTORES ---
    private static void log(String tag, String msg) {
        System.out.println("["+tag+"] " + msg);
        logList.add(0, String.format("[%s] %s: %s", LocalDateTime.now().format(DateTimeFormatter.ofPattern("HH:mm:ss")), tag, msg));
        if(logList.size()>20) logList.remove(20);
    }
    
    private static void ejecutarMotorMatricial() {
        new Thread(() -> {
            while(true) {
                try {
                    ptz("ptzMoveUp", 3000); ptz("ptzMoveLeft", 12000); // Home
                    for(int y=0; y<4; y++) {
                        for(int x=0; x<6; x++) {
                            Thread.sleep(2500);
                            synchronized(frameLock){ snapshotFrame = liveFrame.clone(); }
                            procesarFrame("F"+y+"_C"+x);
                            if(x<5) ptz("ptzMoveRight", 3000);
                        }
                        if(y<3) { ptz("ptzMoveDown", 2000); ptz("ptzMoveLeft", 18000); Thread.sleep(1500); }
                    }
                    Thread.sleep(60000);
                } catch(Exception e){}
            }
        }).start();
    }

    private static void ptz(String cmd, long ms) {
        try { new URL("http://"+IP_CAM+":88/cgi-bin/CGIProxy.fcgi?cmd="+cmd+"&usr="+USR_CAM+"&pwd="+PWD_CAM).openStream().close(); 
        if(ms>0) { Thread.sleep(ms); new URL("http://"+IP_CAM+":88/cgi-bin/CGIProxy.fcgi?cmd=ptzStopRun&usr="+USR_CAM+"&pwd="+PWD_CAM).openStream().close(); }
        } catch(Exception e){}
    }

    private static void videoEngine() {
        new Thread(()->{ while(true){ try{ liveFrame = download("http://"+IP_CAM+":88/cgi-bin/CGIProxy.fcgi?cmd=snapPicture2&usr="+USR_CAM+"&pwd="+PWD_CAM); Thread.sleep(200); }catch(Exception e){} } }).start();
    }

    private static byte[] download(String u) throws Exception { return new URL(u).openStream().readAllBytes(); }
    private static String downloadTxt(String u) { try{return new String(download(u));}catch(Exception e){return "{}";} }
    private static void parseSensor(String r) { /* Parse Arduino Logic */ }
    private static void checkBridge() { try{ new Socket(IP_BRIDGE_IA, 8888).close(); iaServerOnline=true; }catch(Exception e){iaServerOnline=false;} }

    // --- SERVIDOR WEB LOCAL (Respaldo) ---
    private static void iniciarServidorLocal(int port) {
        try {
            HttpServer s = HttpServer.create(new InetSocketAddress(port),0);
            s.createContext("/", e -> {
                String html = "<h1>Zentinel Local Lite</h1><p>Los datos se estan enviando a Firebase.</p><p>Visita tu GitHub Page.</p>";
                e.sendResponseHeaders(200, html.length()); e.getResponseBody().write(html.getBytes()); e.close();
            });
            s.start();
            log("WEB", "Local server en puerto " + port);
        } catch(Exception e){}
    }
}
