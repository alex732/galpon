<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell치n Cloud v5.0 | Gr치ficas y Control 游뾇릖</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0f1d; --card: #161e31; --blue: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; transition: 0.3s; }
        
        body.panic-mode { animation: panic 1s infinite; }
        @keyframes panic { 0% { background: #0a0f1d; } 50% { background: #450a0a; } 100% { background: #0a0f1d; } }

        .dashboard { display: grid; grid-template-columns: 1fr 3fr; gap: 20px; max-width: 1600px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d3748; }
        
        .video-container { background: #000; border-radius: 12px; height: 350px; overflow: hidden; border: 2px solid var(--blue); position: relative; }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; }

        .gauges-container { display: flex; justify-content: space-around; background: #fff; border-radius: 12px; padding: 10px; margin-top: 20px; }
        
        .chart-container { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d3748; margin-top: 20px; height: 300px; }
        
        .log-box { height: 200px; overflow-y: auto; background: #000; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 10px; font-size: 0.8rem; margin-top: 15px; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue);">CAPELL츼N CLOUD - AN츼LISIS DE DATOS 游늳</h1>

<div class="dashboard">
    <div class="card">
        <h3>EDAD DEL LOTE</h3>
        <div style="font-size: 3rem; color: var(--success); text-align: center;" id="dias-lote">0</div>
        <div style="text-align:center;">D칈AS</div>
        <hr style="opacity: 0.1; margin: 20px 0;">
        <div id="target-temp" style="color: #f59e0b; text-align: center;">Temp. Ideal: --춿C</div>
        <button onclick="ajustarFecha()" style="width:100%; margin-top:10px; cursor:pointer;">Reiniciar Lote</button>
        
        <div class="log-box" id="log-display"></div>
    </div>

    <div>
        <div class="video-container">
            <img id="foscam-stream" src="" alt="Cargando video...">
        </div>

        <div class="gauges-container">
            <div id="g_temp"></div>
            <div id="g_hum"></div>
            <div id="g_nh3"></div>
        </div>

        <div class="chart-container">
            <canvas id="tendenciasChart"></canvas>
        </div>
    </div>
</div>

<script>
    // 1. FIREBASE
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. VIDEO
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1000);
    };

    // 3. CONFIGURACI칍N DE LA GR츼FICA (Chart.js)
    const ctx = document.getElementById('tendenciasChart').getContext('2d');
    const tendenciasChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'Temperatura 춿C', borderColor: '#3b82f6', data: [], tension: 0.4, yAxisID: 'y' },
                { label: 'NH3 PPM', borderColor: '#ef4444', data: [], tension: 0.4, yAxisID: 'y1' }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', display: true, position: 'left', grid: {color:'#334155'} },
                y1: { type: 'linear', display: true, position: 'right', grid: {drawOnChartArea: false} }
            },
            plugins: { legend: { labels: { color: 'white' } } }
        }
    });

    // 4. GOOGLE GAUGES Y FIREBASE
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(() => {
        let datT = google.visualization.arrayToDataTable([['Label', 'Value'], ['Temp', 0]]);
        let chartT = new google.visualization.Gauge(document.getElementById('g_temp'));
        let datH = google.visualization.arrayToDataTable([['Label', 'Value'], ['Hum', 0]]);
        let chartH = new google.visualization.Gauge(document.getElementById('g_hum'));
        let datN = google.visualization.arrayToDataTable([['Label', 'Value'], ['NH3', 0]]);
        let chartN = new google.visualization.Gauge(document.getElementById('g_nh3'));

        let opts = { width: 180, height: 180, minorTicks: 5 };

        db.ref('galpon/actual').on('value', (snapshot) => {
            const d = snapshot.val();
            if(d) {
                // Actualizar Gauges
                datT.setValue(0, 1, d.temperatura); chartT.draw(datT, {...opts, redFrom: 32, redTo: 45, yellowFrom: 29, yellowTo: 32});
                datH.setValue(0, 1, d.humedad); chartH.draw(datH, {...opts, redFrom: 80, redTo: 100});
                datN.setValue(0, 1, d.nh3_ppm); chartN.draw(datN, {...opts, redFrom: 20, redTo: 50});

                // Actualizar Gr치fica (M치ximo 20 puntos)
                const hora = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                if (tendenciasChart.data.labels.length > 20) {
                    tendenciasChart.data.labels.shift();
                    tendenciasChart.data.datasets[0].data.shift();
                    tendenciasChart.data.datasets[1].data.shift();
                }
                tendenciasChart.data.labels.push(hora);
                tendenciasChart.data.datasets[0].data.push(d.temperatura);
                tendenciasChart.data.datasets[1].data.push(d.nh3_ppm);
                tendenciasChart.update();

                // L칩gica Lote y Alerta
                updateBatchInfo(d);
            }
        });
    });

    function updateBatchInfo(d) {
        const inicio = new Date(localStorage.getItem('fechaInicio') || new Date());
        const dias = Math.floor((new Date() - inicio) / (1000*60*60*24));
        document.getElementById('dias-lote').innerText = dias;

        if(d.temperatura > 33) document.body.classList.add('panic-mode');
        else document.body.classList.remove('panic-mode');

        const log = document.getElementById('log-display');
        log.innerHTML = `<div>[${new Date().toLocaleTimeString()}] T:${d.temperatura}춿 N:${d.nh3_ppm}</div>` + log.innerHTML;
    }

    function ajustarFecha() {
        const nueva = prompt("Fecha inicio lote (AAAA-MM-DD):");
        if(nueva) { localStorage.setItem('fechaInicio', new Date(nueva).toISOString()); location.reload(); }
    }
</script>
</body>
</html>
