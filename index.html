<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud | Control Total</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --blue: #3b82f6; --green: #22c55e; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 20px; }
        .grid-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; max-width: 1200px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #334155; }
        #foscam-stream { width: 100%; height: 400px; background: #000; border-radius: 10px; object-fit: contain; border: 2px solid var(--blue); }
        .sensor-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .sensor-box { background: #0f172a; padding: 15px; border-radius: 10px; text-align: center; border-bottom: 3px solid var(--blue); }
        .val { font-size: 2rem; font-weight: bold; display: block; }
        .label { font-size: 0.8rem; color: #94a3b8; text-transform: uppercase; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.85rem; }
        .history-table th { text-align: left; padding: 10px; background: #334155; }
        .history-table td { padding: 10px; border-bottom: 1px solid #334155; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue);">CAPELL√ÅN CLOUD üö¶</h1>

<div class="grid-container">
    <div>
        <div class="card">
            <h3>VIDEO EN TIEMPO REAL</h3>
            <img id="foscam-stream" src="" alt="Cargando stream...">
            <p id="v-status" style="font-size:0.8rem">Iniciando flujo autom√°tico...</p>
        </div>

        <div class="sensor-grid">
            <div class="sensor-box"><span class="label">Temperatura</span><span class="val" id="t-val">--¬∞C</span></div>
            <div class="sensor-box"><span class="label">Humedad</span><span class="val" id="h-val">--%</span></div>
            <div class="sensor-box"><span class="label">Amon√≠aco (NH3)</span><span class="val" id="n-val">-- PPM</span></div>
            <div class="sensor-box"><span class="label">Lluvia</span><span class="val" id="r-val">--</span></div>
        </div>
    </div>

    <div class="card">
        <h3>HISTORIAL RECIENTE</h3>
        <table class="history-table">
            <thead><tr><th>Hora</th><th>Temp</th><th>NH3</th></tr></thead>
            <tbody id="h-body"></tbody>
        </table>
    </div>
</div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE (URL ACTUALIZADA)
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. VIDEO AUTOM√ÅTICO
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const vStatus = document.getElementById("v-status");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";

        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1200);
        img.onload = () => vStatus.innerHTML = "üî¥ <span style='color:var(--green)'>EN VIVO</span>";
        img.onerror = () => vStatus.innerHTML = "‚ùå <span style='color:#ef4444'>ERROR: REVISA SERVIDOR JAVA O PERMISOS</span>";
    };

    // 3. SENSORES (RUTA: galpon/actual)
    db.ref('galpon/actual').on('value', (snapshot) => {
        const d = snapshot.val();
        if(d) {
            document.getElementById('t-val').innerText = d.temperatura + "¬∞C";
            document.getElementById('h-val').innerText = d.humedad + "%";
            document.getElementById('n-val').innerText = d.nh3_ppm + " PPM";
            document.getElementById('r-val').innerText = d.lluvia;

            // Guardar en tabla de historial
            const body = document.getElementById('h-body');
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            const row = `<tr><td>${time}</td><td>${d.temperatura}¬∞</td><td>${d.nh3_ppm}</td></tr>`;
            body.insertAdjacentHTML('afterbegin', row);
            if(body.rows.length > 10) body.deleteRow(10);
        }
    });
</script>
</body>
</html>
