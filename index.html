<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud v4.0 | Control Av√≠cola RD üá©üá¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <style>
        :root { --bg: #0a0f1d; --card: #161e31; --blue: #3b82f6; --danger: #ef4444; --success: #22c55e; }
        body { background: var(--bg); color: white; font-family: 'Inter', sans-serif; margin: 0; padding: 20px; transition: 0.3s; }
        
        /* Alerta Visual de P√°nico */
        body.panic-mode { animation: panic 1s infinite; }
        @keyframes panic { 0% { background: #0a0f1d; } 50% { background: #450a0a; } 100% { background: #0a0f1d; } }

        .dashboard { display: grid; grid-template-columns: 1fr 2.5fr 1fr; gap: 20px; max-width: 1500px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d3748; text-align: center; }
        
        /* Video */
        .video-container { position: relative; background: #000; border-radius: 12px; height: 450px; overflow: hidden; border: 2px solid var(--blue); }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; }

        /* Gauges */
        .gauge-flex { display: flex; flex-direction: column; align-items: center; gap: 10px; background: #f8fafc; border-radius: 10px; padding: 10px; }
        
        /* Log */
        .log-box { height: 350px; overflow-y: auto; background: #000; color: #00ff00; font-family: monospace; padding: 10px; border-radius: 10px; text-align: left; font-size: 0.8rem; }
        .log-entry { border-bottom: 1px solid #1a1a1a; padding: 4px 0; }
        
        .btn-lote { background: var(--blue); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue);">CAPELL√ÅN CLOUD - GESTI√ìN DE POLLOS DE ENGORDE üá©üá¥</h1>

<div class="dashboard">
    <div class="card">
        <h3>LOTE ACTUAL</h3>
        <div style="font-size: 3rem; color: var(--success);" id="dias-lote">0</div>
        <div style="font-size: 1.2rem;">D√çAS DE EDAD</div>
        <hr style="opacity: 0.1; margin: 20px 0;">
        <div id="target-temp" style="color: #f59e0b;">Temp. Ideal: --¬∞C</div>
        <button class="btn-lote" onclick="ajustarFecha()">Reiniciar Lote</button>
        <hr style="opacity: 0.1; margin: 20px 0;">
        <h4>LLUVIA</h4>
        <div id="rain-val" style="font-size: 1.5rem;">--</div>
    </div>

    <div>
        <div class="video-container">
            <div style="position:absolute; top:10px; left:10px; background:red; padding:2px 8px; border-radius:4px; font-size:0.7rem;">LIVE</div>
            <img id="foscam-stream" src="" alt="Conectando al servidor Java...">
        </div>
        <div class="card" style="margin-top:20px; text-align: left; border-left: 5px solid var(--blue);">
            <strong style="color:var(--blue)">üí° MEJORES PR√ÅCTICAS RD:</strong>
            <p id="advice-text">Analizando clima del galp√≥n...</p>
        </div>
    </div>

    <div class="card">
        <h3>SENSORES</h3>
        <div class="gauge-flex">
            <div id="g_temp"></div>
            <div id="g_hum"></div>
            <div id="g_nh3"></div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <h3>LOG DE MONITOREO E HISTORIAL</h3>
    <div id="log-display" class="log-box"></div>
</div>

<script>
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Fecha inicial (se guarda en localStorage para que no se borre)
    if(!localStorage.getItem('fechaInicio')) localStorage.setItem('fechaInicio', new Date().toISOString());

    function ajustarFecha() {
        const nueva = prompt("Ingrese fecha de inicio (AAAA-MM-DD):", new Date().toISOString().split('T')[0]);
        if(nueva) { localStorage.setItem('fechaInicio', new Date(nueva).toISOString()); location.reload(); }
    }

    // 2. VIDEO AUTOM√ÅTICO (Cada 1 seg)
    window.onload = function() {
        const img = document.getElementById("foscam-stream");
        const PROXY = "http://192.168.2.208:9005/stream-galpon";
        setInterval(() => { img.src = PROXY + "?t=" + Date.now(); }, 1000);
    };

    // 3. GAUGES (SEMAFORIZACI√ìN)
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(initCharts);

    let datT, datH, datN, chartT, chartH, chartN;

    function initCharts() {
        datT = google.visualization.arrayToDataTable([['Label', 'Value'], ['Temp ¬∞C', 0]]);
        chartT = new google.visualization.Gauge(document.getElementById('g_temp'));
        datH = google.visualization.arrayToDataTable([['Label', 'Value'], ['Hum %', 0]]);
        chartH = new google.visualization.Gauge(document.getElementById('g_hum'));
        datN = google.visualization.arrayToDataTable([['Label', 'Value'], ['NH3 PPM', 0]]);
        chartN = new google.visualization.Gauge(document.getElementById('g_nh3'));

        let optT = { width: 200, height: 200, redFrom: 32, redTo: 45, yellowFrom: 29, yellowTo: 32, greenFrom: 20, greenTo: 29, max: 45 };
        let optH = { width: 200, height: 200, redFrom: 80, redTo: 100, yellowFrom: 70, yellowTo: 80, greenFrom: 40, greenTo: 70 };
        let optN = { width: 200, height: 200, redFrom: 20, redTo: 50, yellowFrom: 10, yellowTo: 20, greenFrom: 0, greenTo: 10, max: 50 };

        // LECTURA DESDE RUTA: galpon/actual
        db.ref('galpon/actual').on('value', (snapshot) => {
            const d = snapshot.val();
            if(d) {
                datT.setValue(0, 1, d.temperatura); chartT.draw(datT, optT);
                datH.setValue(0, 1, d.humedad); chartH.draw(datH, optH);
                datN.setValue(0, 1, d.nh3_ppm); chartN.draw(datN, optN);
                document.getElementById('rain-val').innerText = d.lluvia;
                
                updateLogic(d);
            }
        });
    }

    function updateLogic(d) {
        // C√°lculo de d√≠as del lote
        const inicio = new Date(localStorage.getItem('fechaInicio'));
        const dias = Math.floor((new Date() - inicio) / (1000*60*60*24));
        document.getElementById('dias-lote').innerText = dias;

        // Temperatura ideal seg√∫n mejores pr√°cticas (Pollos de Engorde)
        let ideal = 32; // Sem 1
        if(dias > 7) ideal = 29; // Sem 2
        if(dias > 14) ideal = 26; // Sem 3
        if(dias > 21) ideal = 23; // Sem 4+
        document.getElementById('target-temp').innerText = `Temp. Ideal: ${ideal}¬∞C`;

        // Alerta de P√°nico (Parpadeo)
        if(d.temperatura > 33 || d.nh3_ppm > 25) document.body.classList.add('panic-mode');
        else document.body.classList.remove('panic-mode');

        // Consejos RD
        const adv = document.getElementById('advice-text');
        if(d.temperatura > (ideal + 3)) adv.innerText = "‚ö†Ô∏è CALOR EXTREMO: Active ventiladores. Los pollos en RD sufren estr√©s t√©rmico sobre los 32¬∞C.";
        else if(d.nh3_ppm > 15) adv.innerText = "‚ö†Ô∏è AMON√çACO ALTO: Nivel peligroso para los pulmones. Ventile el galp√≥n.";
        else adv.innerText = "‚úÖ Condiciones estables para la edad del lote.";

        // Log Hist√≥rico
        const log = document.getElementById('log-display');
        const time = new Date().toLocaleTimeString();
        log.innerHTML = `<div class="log-entry">[${time}] Lectura: T:${d.temperatura}¬∞ | H:${d.humedad}% | NH3:${d.nh3_ppm}</div>` + log.innerHTML;
        if(log.childNodes.length > 50) log.removeChild(log.lastChild);
    }
</script>
</body>
</html>
