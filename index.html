<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galpón Lite - Monitoreo Remoto</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --accent: #38bdf8;
            --text-main: #f1f5f9;
        }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            margin: 0; padding: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }
        .container { max-width: 900px; width: 100%; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--accent); padding-bottom: 10px; }
        
        /* Dashboard Layout */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        
        /* Gauges */
        #gauges_container { display: flex; justify-content: space-around; flex-wrap: wrap; min-height: 160px; }
        
        /* Presets de Suelo */
        .presets-gallery { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); 
            gap: 10px; margin-top: 15px; 
        }
        .preset-card { border: 1px solid #334155; border-radius: 8px; overflow: hidden; background: #000; }
        .preset-card img { width: 100%; height: auto; display: block; opacity: 0.8; transition: 0.3s; }
        .preset-card img:hover { opacity: 1; }
        .preset-label { font-size: 10px; text-align: center; padding: 5px; color: var(--accent); }

        .status-lite { font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Control Galpón <span style="color:var(--accent)">Lite</span></h1>
        <div class="status-lite">Visualización Remota | GitHub Pages</div>
    </div>

    <div class="dashboard">
        <div class="card">
            <h3>Sensores Ambientales</h3>
            <div id="gauges_container"></div>
            <p style="font-size: 12px; color: #64748b; text-align: center;">
                Actualizado vía Firebase Realtime
            </p>
        </div>

        <div class="card">
            <h3>Presets de Escaneo Inicial</h3>
            <p style="font-size: 13px;">Basado en Home Lógico: <strong>X:0, Y:-50</strong></p>
            <div id="presets_gallery" class="presets-gallery">
                </div>
        </div>
    </div>
</div>

<script>
    // --- DATOS DE CONFIGURACIÓN ---
    // Asegúrate de usar tus credenciales de Firebase aquí
    const firebaseConfig = {
        apiKey: "TU_API_KEY",
        databaseURL: "TU_DATABASE_URL",
        projectId: "TU_PROJECT_ID",
        storageBucket: "TU_STORAGE_BUCKET"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- LÓGICA DE GAUGES (GOOGLE CHARTS) ---
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(drawCharts);

    let gaugeData, gaugeOptions, chart;

    function drawCharts() {
        gaugeData = google.visualization.arrayToDataTable([
            ['Label', 'Value'],
            ['Temp °C', 0],
            ['Hum %', 0]
        ]);

        gaugeOptions = {
            width: 400, height: 160,
            redFrom: 35, redTo: 50,
            yellowFrom: 30, yellowTo: 35,
            minorTicks: 5,
            max: 50,
            greenFrom: 20, greenTo: 30
        };

        chart = new google.visualization.Gauge(document.getElementById('gauges_container'));
        chart.draw(gaugeData, gaugeOptions);

        // Vincular con Firebase
        escucharSensores();
    }

    // --- LISTENERS DE DATOS (FIREBASE) ---
    function escucharSensores() {
        // Referencia a la base de datos configurada
        db.ref('galpon/data_actual').on('value', (snapshot) => {
            try {
                const data = snapshot.val();
                if (data) {
                    // Actualizar los Gauges
                    gaugeData.setValue(0, 1, data.temperatura || 0);
                    gaugeData.setValue(1, 1, data.humedad || 0);
                    chart.draw(gaugeData, gaugeOptions);
                }
            } catch (error) {
                console.error("Error en lectura Lite: ", error);
            }
        });
    }

    // Listener para cargar imágenes de Presets (Scan Inicial de Suelo)
    db.ref('galpon/presets_suelo').limitToLast(6).on('child_added', (snapshot) => {
        try {
            const preset = snapshot.val();
            const gallery = document.getElementById('presets_gallery');
            
            const card = document.createElement('div');
            card.className = 'preset-card';
            card.innerHTML = `
                <img src="${preset.url}" alt="Preset">
                <div class="preset-label">Pos: ${preset.angulo}°</div>
            `;
            gallery.prepend(card); // Mostrar el más reciente primero
        } catch (e) {
            console.error("Error cargando presets: ", e);
        }
    });

</script>
</body>
</html>
