<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud v13.0 | IA Multi-Zona üá©üá¥</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0a0f1d; --card: #161e31; --blue: #3b82f6; --danger: #ef4444; --success: #22c55e; --warn: #f59e0b; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 2.5fr 1fr; gap: 20px; max-width: 1600px; margin: auto; }
        .card { background: var(--card); border-radius: 15px; padding: 20px; border: 1px solid #2d3748; }
        .video-box { position: relative; background: #000; border-radius: 12px; height: 380px; overflow: hidden; border: 2px solid var(--blue); }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; }
        .gauges-wrapper { display: flex; flex-direction: column; align-items: center; gap: 10px; background: white; border-radius: 10px; padding: 10px; }
        
        /* ZONAS IA */
        .zones-container { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 15px; }
        .zone-card { background: #0a0f1d; padding: 10px; border-radius: 8px; border-top: 3px solid var(--blue); }
        .zone-card b { font-size: 0.8rem; color: var(--blue); }
        .zone-card p { font-size: 0.85rem; margin: 5px 0 0 0; line-height: 1.2; color: #cbd5e1; }

        .chart-container { grid-column: span 3; height: 350px; margin-top: 15px; }
        .log-container { grid-column: span 3; margin-top: 15px; }
        .log-header { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1.5fr 1fr; padding: 10px; background: #1e293b; font-weight: bold; border-radius: 10px 10px 0 0; }
        .log-box { height: 200px; overflow-y: auto; background: #000; color: #0f0; font-family: monospace; padding: 10px; border: 1px solid #334155; }
        .log-entry { display: grid; grid-template-columns: 1.5fr 1fr 1fr 1.5fr 1fr; padding: 5px 10px; border-bottom: 1px solid #222; }
        button { background: var(--blue); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

<h1 style="text-align:center; color: var(--blue); margin-bottom: 20px;">CAPELL√ÅN CLOUD - INSPECCI√ìN AUTOMATIZADA üá©üá¥</h1>

<div class="dashboard-grid">
    <div class="card">
        <h3>LOTE</h3>
        <div style="font-size: 3rem; color: var(--success); text-align: center;" id="dias-lote">0</div>
        <div style="text-align:center;">D√çAS</div>
        <hr style="opacity:0.1; margin:15px 0;">
        <div id="target-temp" style="color: var(--warn); text-align: center; font-weight: bold;">--</div>
        <button onclick="reiniciarLote()" style="margin-top:10px;">Nuevo Lote</button>
        <div id="rain-val" style="font-size: 1.2rem; text-align: center; margin-top:20px; font-weight: bold;">--</div>
    </div>

    <div>
        <div class="card video-box">
            <img id="foscam-stream" src="">
        </div>
        <div class="card" style="margin-top: 15px;">
            <strong style="color: var(--blue)">üîç REPORTE DE IA POR ZONAS:</strong>
            <div class="zones-container">
                <div class="zone-card"><b>üìç ENTRADA (Z1)</b><p id="txt-z1">Esperando ronda...</p></div>
                <div class="zone-card"><b>üìç CENTRO (Z2)</b><p id="txt-z2">Esperando ronda...</p></div>
                <div class="zone-card"><b>üìç FONDO (Z3)</b><p id="txt-z3">Esperando ronda...</p></div>
            </div>
        </div>
    </div>

    <div class="card">
        <h3 style="text-align:center;">VIVO</h3>
        <div class="gauges-wrapper">
            <div id="g_t"></div><div id="g_h"></div><div id="g_n"></div>
        </div>
    </div>

    <div class="card chart-container">
        <canvas id="historialChart"></canvas>
    </div>

    <div class="log-container">
        <div class="log-header"><div>HORA</div><div>TEMP</div><div>HUM</div><div>NH3</div><div>LLUVIA</div></div>
        <div id="log-display" class="log-box"></div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // VIDEO
    const img = document.getElementById("foscam-stream");
    setInterval(() => { img.src = "http://192.168.2.208:9005/stream-galpon?t=" + Date.now(); }, 1000);

    // ESCUCHAR ZONAS IA
    [1, 2, 3].forEach(id => {
        db.ref('galpon/analisis_ia/zona_' + id).on('value', (snap) => {
            if(snap.exists()) document.getElementById('txt-z' + id).innerText = snap.val();
        });
    });

    // GR√ÅFICA Y SENSORES
    google.charts.load('current', {'packages':['gauge']});
    google.charts.setOnLoadCallback(() => {
        let chT = new google.visualization.Gauge(document.getElementById('g_t'));
        let chH = new google.visualization.Gauge(document.getElementById('g_h'));
        let chN = new google.visualization.Gauge(document.getElementById('g_n'));
        let opts = { width: 180, height: 180, redFrom: 32, redTo: 45, yellowFrom: 29, yellowTo: 32, max: 45 };

        db.ref('galpon/actual').on('value', (snap) => {
            const d = snap.val();
            if(d) {
                chT.draw(google.visualization.arrayToDataTable([['L','V'],['Temp', d.temperatura]]), opts);
                chH.draw(google.visualization.arrayToDataTable([['L','V'],['Hum', d.humedad]]), {...opts, redFrom:80, max:100});
                chN.draw(google.visualization.arrayToDataTable([['L','V'],['NH3', d.nh3_ppm]]), {...opts, redFrom:20, max:50});
                document.getElementById('rain-val').innerText = d.lluvia === "SI" ? "üåßÔ∏è LLUEVE" : "‚òÄÔ∏è SECO";
                actualizarInterfaz(d);
            }
        });
    });

    function actualizarInterfaz(d) {
        const start = new Date(localStorage.getItem('batchStart') || new Date());
        const days = Math.floor((new Date() - start) / (1000*60*60*24));
        document.getElementById('dias-lote').innerText = days;
        
        const log = document.getElementById('log-display');
        const entry = `<div class="log-entry">
            <div>${new Date().toLocaleTimeString()}</div>
            <div>${d.temperatura}¬∞C</div><div>${d.humedad}%</div>
            <div>${d.nh3_ppm}</div><div>${d.lluvia}</div>
        </div>`;
        log.innerHTML = entry + log.innerHTML;
        if(log.childNodes.length > 40) log.removeChild(log.lastChild);
    }

    function reiniciarLote() {
        const f = prompt("Fecha inicio (AAAA-MM-DD):");
        if(f) { localStorage.setItem('batchStart', new Date(f).toISOString()); location.reload(); }
    }
</script>
</body>
</html>
