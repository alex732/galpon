<!DOCTYPE html>
<html lang='es'>
<head>
    <meta charset='UTF-8'>
    <title>ZENTINEL GLOBAL v258</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <style>
        body{background:#0b1120;color:#f8fafc;font-family:sans-serif;margin:0;overflow-y:auto}
        .header{background:#020617;border-bottom:2px solid #1e293b;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100}
        .brand{font-size:18px;font-weight:900;color:#38bdf8;letter-spacing:1px}
        .layout{display:grid;grid-template-columns:180px 1fr 300px;gap:10px;padding:10px}
        .col{display:flex;flex-direction:column;gap:10px}
        .card{background:#111827;border:1px solid #1e293b;border-radius:4px;padding:10px}
        .card-h{font-size:10px;color:#38bdf8;font-weight:800;border-bottom:1px solid #1e293b;margin-bottom:10px;text-transform:uppercase}
        .gauge-box{background:#020617;border-radius:50%;width:85px;height:85px;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0 auto 10px;border:3px solid #22c55e}
        .v-val{font-size:18px;font-weight:bold}
        .v-lbl{font-size:8px;color:#94a3b8}
        .live-snap{width:100%;height:320px;background:#000;border-radius:4px;object-fit:cover;border:2px solid #334155}
        .matrix{display:grid;grid-template-columns:repeat(6,1fr);gap:2px;margin-top:10px}
        .cell{height:32px;background:#000;border:1px solid #1e293b;position:relative;border-radius:2px;cursor:pointer;overflow:hidden;transition:border 0.3s ease;box-sizing:border-box;}
        .cell img{width:100%;height:100%;object-fit:cover;opacity:0.8;transition:opacity 0.3s ease;}
        .cell.active{border:2px solid #10b981;box-shadow:inset 0 0 10px #10b981;}
        .cell.active img{opacity:1;}
        .cell-tag{position:absolute;bottom:0;width:100%;font-size:5px;background:rgba(0,0,0,0.8);text-align:center;color:#38bdf8}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;justify-content:center;align-items:center}
        .modal img{max-width:90%;max-height:80%;border:2px solid #38bdf8;border-radius:8px}
        .close-btn{position:absolute;top:20px;right:20px;padding:10px;background:#ef4444;color:#fff;cursor:pointer;border-radius:4px;font-weight:bold}
        .sys-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:5px}
        .sys-item{background:#020617;padding:5px;text-align:center;font-size:9px;border:1px solid #1e293b}
        .sys-val{display:block;color:#38bdf8;font-weight:bold}
        #chat, #sensor-log{white-space:pre-wrap;word-wrap:break-word;color:#10b981;font-family:monospace;overflow-y:auto;}
        #ia-log{white-space:pre-wrap;word-wrap:break-word;color:#38bdf8;overflow-y:auto;}
        .wifi-container{display:flex;align-items:flex-end;gap:2px;height:12px;justify-content:center;margin-bottom:2px;}
        .w-bar{width:3px;background:#334155;border-radius:1px;}
        .w-bar.on{background:#10b981;box-shadow:0 0 5px #10b981;}
        .wb1{height:25%}.wb2{height:50%}.wb3{height:75%}.wb4{height:100%}
        .pulse-dot{display:inline-block;width:6px;height:6px;border-radius:50%;background:#334155;vertical-align:middle;margin-right:3px;}
        .pulse-dot.beat{animation:heartbeat 0.5s ease-out;}
        @keyframes heartbeat{0%{transform:scale(1);background:#10b981;box-shadow:0 0 8px #10b981;}100%{transform:scale(1);background:#334155;}}
    </style>
</head>
<body>
    <div id='modal' class='modal' onclick="this.style.display='none'">
        <div class='close-btn'>CERRAR</div>
        <img id='modal-img' src=''>
    </div>

    <div class='header'>
        <div class='brand'>ZENTINEL GLOBAL v258</div>
        <div id='topDate' style='font-family:monospace;color:#94a3b8'>--/--/-- --:--:--</div>
    </div>

    <div class='layout'>
        <div class='col'>
            <div class='card'>
                <div class='card-h'>Sensores</div>
                <div class='gauge-box' id='bgT'><span id='vT' class='v-val'>--</span><span class='v-lbl'>TEMP</span></div>
                <div class='gauge-box' id='bgH'><span id='vH' class='v-val'>--</span><span class='v-lbl'>HUM</span></div>
                <div class='gauge-box' id='bgN'><span id='vN' class='v-val'>--</span><span class='v-lbl'>NH3</span></div>
                <div class='card' style='text-align:center;padding:5px;'><span id='vR' style='font-size:25px'>☀️</span></div>
            </div>
            <div class='card'>
                <div class='card-h'>Satélite NOAA</div>
                <img src='https://cdn.star.nesdis.noaa.gov/GOES16/ABI/SECTOR/car/GEOCOLOR/latest.jpg' style='width:100%'>
            </div>
            <div class='card'>
                <div class='card-h'>IA Clima</div>
                <div id='w-pred' style='font-size:10px;font-family:monospace;color:#a7f3d0;'>Esperando datos...</div>
            </div>
        </div>

        <div class='col'>
            <div id='banner' style='background:#064e3b;padding:10px;text-align:center;font-weight:bold;border-radius:4px;margin-bottom:10px;border:1px solid #10b981;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;'>
                <span style='color:#a7f3d0;font-size:9px;text-transform:uppercase;'>[ CONECTANDO A FIREBASE... ]</span>
            </div>
            <img id='live-snap' class='live-snap' src=''>
            <div id='matrix' class='matrix'></div>
            <div class='card'>
                <div class='card-h'>Terminal Remoto</div>
                <div id='chat' style='height:120px;background:#020617;border:1px solid #38bdf8;padding:5px;font-size:9px;'></div>
            </div>
            <div class='card'>
                <div class='card-h'>Data Logger Arduino</div>
                <div id='sensor-log' style='height:120px;background:#020617;border:1px solid #22c55e;padding:5px;font-size:10px;color:#f8fafc'></div>
            </div>
        </div>

        <div class='col'>
            <div class='card'>
                <div class='card-h'>Sistema & Red</div>
                <div class='sys-grid'>
                    <div class='sys-item'><span id='cpu' class='sys-val'>--</span>CPU</div>
                    <div class='sys-item'><span id='ram' class='sys-val'>--</span>RAM</div>
                    <div class='sys-item'><span id='dsk' class='sys-val'>--</span>DSK</div>
                </div>
                <div class='sys-grid' style='margin-top:5px'>
                    <div class='sys-item'><span id='ptemp' class='sys-val'>--</span>TMP</div>
                    <div class='sys-item'>
                        <div class='wifi-container'>
                            <div id='wb1' class='w-bar wb1'></div><div id='wb2' class='w-bar wb2'></div><div id='wb3' class='w-bar wb3'></div><div id='wb4' class='w-bar wb4'></div>
                        </div>
                        <span id='wsig-txt' style='font-size:7px;color:#38bdf8;'>--</span>
                    </div>
                    <div class='sys-item' style='white-space:nowrap;overflow:hidden;'><span id='wssid' class='sys-val'>--</span>RED</div>
                </div>
                <div class='sys-grid' style='margin-top:5px'>
                    <div class='sys-item'>CAM: <span id='cam-pulse' class='pulse-dot'></span></div>
                    <div class='sys-item'>ARD: <span id='ard-pulse' class='pulse-dot'></span></div>
                    <div class='sys-item'>IA: <span id='ia-pulse' class='pulse-dot'></span></div>
                </div>
            </div>
            <div class='card'>
                <div class='card-h'>Alertas IA (Dell)</div>
                <div id='ia-log' style='height:150px;font-size:10px;font-family:monospace;padding:5px;'></div>
            </div>
            <div class='card'>
                <div class='card-h'>Radar RD</div>
                <iframe style='width:100%;height:130px;border:0;' src='https://radar-met2.sna.gob.do/'></iframe>
            </div>
            <div class='card'>
                <div class='card-h'>Windy PP</div>
                <iframe style='width:100%;height:130px;border:0;' src='https://embed.windy.com/embed2.html?lat=19.7253&lon=-70.7397&zoom=11'></iframe>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACION DE FIREBASE (REEMPLAZA ESTO) ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            databaseURL: "https://TU_PROYECTO-default-rtdb.firebaseio.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "SENDER_ID",
            appId: "APP_ID"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 2. DIBUJAR MATRIZ ---
        const matrixEl = document.getElementById('matrix');
        for(let y=0; y<5; y++){
            for(let x=0; x<6; x++){
                let id = 'F'+y+'_C'+x;
                matrixEl.innerHTML += `<div class="cell" id="d_${id}" onclick="openModal('${id}')"><img id="img_${id}" src=""><div class="cell-tag">${id}</div></div>`;
            }
        }

        function openModal(id){
            document.getElementById('modal-img').src = document.getElementById('img_'+id).src;
            document.getElementById('modal').style.display='flex';
        }

        let lastCamUpdateTs = 0; let lastArdUpdateTs = 0; let lastIaUpdateTs = 0;

        // --- 3. ESCUCHAR DATOS GENERALES EN TIEMPO REAL ---
        db.ref('zentinel/data').on('value', (snapshot) => {
            const d = snapshot.val();
            if(!d) return;

            document.getElementById('vT').innerText = (d.t || '--') + '°';
            document.getElementById('vH').innerText = (d.h || '--') + '%';
            document.getElementById('vN').innerText = (d.n || '--');
            document.getElementById('vR').innerText = (d.r || '☀️');
            document.getElementById('topDate').innerText = d.ts || '--';
            document.getElementById('cpu').innerText = d.cpu || '--';
            document.getElementById('ram').innerText = d.ram || '--';
            document.getElementById('dsk').innerText = d.dsk || '--';
            document.getElementById('ptemp').innerText = d.pt || '--';
            document.getElementById('wssid').innerText = d.wn || '--';
            document.getElementById('w-pred').innerText = d.wp || '--';

            // Logs
            let chatEl = document.getElementById('chat');
            if(d.logs && Array.isArray(d.logs)){
                let wasAtBottom = chatEl.scrollHeight - chatEl.scrollTop === chatEl.clientHeight;
                chatEl.innerHTML = d.logs.join('\n');
                if(wasAtBottom) chatEl.scrollTop = chatEl.scrollHeight;
            }

            let sLogEl = document.getElementById('sensor-log');
            if(d.s_logs && Array.isArray(d.s_logs)){
                let wasAtBottomS = sLogEl.scrollHeight - sLogEl.scrollTop === sLogEl.clientHeight;
                sLogEl.innerHTML = d.s_logs.join('\n');
                if(wasAtBottomS) sLogEl.scrollTop = sLogEl.scrollHeight;
            }

            let iaLogEl = document.getElementById('ia-log');
            let latestAlert = 'ESPERANDO ANÁLISIS DE LA DELL...';
            if(d.ia_logs && Array.isArray(d.ia_logs)){
                let wasAtBottomIA = iaLogEl.scrollHeight - iaLogEl.scrollTop === iaLogEl.clientHeight;
                iaLogEl.innerHTML = d.ia_logs.join('<br><br>');
                if(wasAtBottomIA) iaLogEl.scrollTop = iaLogEl.scrollHeight;
                if(d.ia_logs.length > 0) latestAlert = d.ia_logs[d.ia_logs.length-1].replace('► ','');
            }

            document.getElementById('banner').innerHTML = `<span style='color:#a7f3d0;font-size:9px;text-transform:uppercase;'>[ ESTADO DEL SISTEMA: ${d.ia || '--'} ]</span><span style='color:#38bdf8;font-size:13px;'>${latestAlert}</span>`;

            // Heartbeats
            let pulseCam = document.getElementById('cam-pulse');
            if(d.lcu > lastCamUpdateTs){ pulseCam.classList.remove('beat'); void pulseCam.offsetWidth; pulseCam.classList.add('beat'); lastCamUpdateTs = d.lcu; }
            
            let pulseArd = document.getElementById('ard-pulse');
            if(d.lau > lastArdUpdateTs){ pulseArd.classList.remove('beat'); void pulseArd.offsetWidth; pulseArd.classList.add('beat'); lastArdUpdateTs = d.lau; }
            
            let pulseIa = document.getElementById('ia-pulse');
            if(d.liu > lastIaUpdateTs){ pulseIa.classList.remove('beat'); void pulseIa.offsetWidth; pulseIa.classList.add('beat'); lastIaUpdateTs = d.liu; }

            // WiFi
            if(d.ws) {
                let dbmStr = d.ws.replace('dBm','').trim();
                let dbm = parseInt(dbmStr);
                if(!isNaN(dbm)){
                    let bars=0;
                    if(dbm>-50) bars=4; else if(dbm>-60) bars=3; else if(dbm>-70) bars=2; else if(dbm>-120) bars=1;
                    for(let i=1; i<=4; i++) document.getElementById('wb'+i).classList.toggle('on', i<=bars);
                    document.getElementById('wsig-txt').innerText = d.ws;
                }
            }

            // Celda Activa
            let cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('active'));
            if(d.ac && d.ac !== 'none'){
                let target = document.getElementById('d_'+d.ac);
                if(target) target.classList.add('active');
            }
        });

        // --- 4. ESCUCHAR IMAGENES (BASE64) ---
        db.ref('zentinel/images/live').on('value', (s) => {
            if(s.val()) document.getElementById('live-snap').src = 'data:image/jpeg;base64,' + s.val();
        });

        // Escuchar la matriz entera
        db.ref('zentinel/images/matrix').on('value', (s) => {
            const matrixData = s.val();
            if(matrixData){
                for (const [cellId, base64Str] of Object.entries(matrixData)) {
                    let imgEl = document.getElementById('img_' + cellId);
                    if(imgEl) imgEl.src = 'data:image/jpeg;base64,' + base64Str;
                }
            }
        });
    </script>
</body>
</html>
