<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capell√°n Cloud | Dashboard Profesional</title>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>

    <style>
        :root {
            --bg: #0f172a; --card: #1e293b; --text: #f8fafc;
            --primary: #3b82f6; --safe: #22c55e; --danger: #ef4444;
        }
        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 20px; text-align: center;
        }
        .container { max-width: 1200px; margin: auto; }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px; margin-top: 30px;
        }
        .card {
            background: var(--card); border-radius: 20px;
            padding: 25px; border: 4px solid #334155;
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            transition: transform 0.3s ease;
        }
        .card:hover { transform: translateY(-5px); }
        .val { font-size: 3.5rem; font-weight: bold; margin: 15px 0; }
        
        /* Video Container */
        .cam-box {
            width: 100%; height: 350px; background: #000;
            border-radius: 15px; border: 3px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        #video-stream { width: 100%; height: 100%; object-fit: contain; display: none; }
        
        .btn-main {
            background: var(--primary); color: white; border: none;
            padding: 18px; border-radius: 12px; cursor: pointer;
            font-weight: bold; width: 100%; margin-bottom: 15px; font-size: 1.1rem;
        }
        .btn-main:hover { filter: brightness(1.2); }

        .ptz-group { margin-top: 15px; }
        .ptz-btn {
            background: #334155; color: white; border: none;
            padding: 15px; border-radius: 10px; cursor: pointer;
            margin: 4px; width: 60px; font-size: 1.3rem;
        }
        .ptz-btn:active { background: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--primary); letter-spacing: 2px;">CAPELL√ÅN CLOUD üö¶</h1>
    <p style="color: #64748b;">Monitoreo de Galp√≥n en Tiempo Real</p>

    <div class="grid">
        <div id="card-nh3" class="card">
            <h3>AMON√çACO (NH‚ÇÉ)</h3>
            <canvas id="gauge-nh3" style="width: 100%; height: 160px;"></canvas>
            <div id="val-nh3" class="val">--</div>
            <p id="label-nh3" style="font-weight: bold;">Cargando...</p>
        </div>

        <div id="card-temp" class="card">
            <h3>TEMPERATURA</h3>
            <canvas id="gauge-temp" style="width: 100%; height: 160px;"></canvas>
            <div id="val-temp" class="val">--</div>
            <p id="label-temp" style="font-weight: bold;">Cargando...</p>
        </div>

        <div class="card" style="border-color: var(--primary);">
            <button id="btn-stream" class="btn-main" onclick="conectarStream()">CONECTAR VIDEO PROXY</button>
            <div class="cam-box">
                <img id="video-stream" src="">
                <div id="status-text" style="color: #475569;">Esperando Servidor Java...</div>
            </div>
            <div class="ptz-group">
                <button class="ptz-btn" onclick="controlar('ptzMoveUp')">‚ñ≤</button><br>
                <button class="ptz-btn" onclick="controlar('ptzMoveLeft')">‚óÑ</button>
                <button class="ptz-btn" onclick="controlar('ptzReset')">üè†</button>
                <button class="ptz-btn" onclick="controlar('ptzMoveRight')">‚ñ∫</button><br>
                <button class="ptz-btn" onclick="controlar('ptzMoveDown')">‚ñº</button>
            </div>
        </div>
    </div>
</div>

<script>
    /* ================= CONFIGURACI√ìN ================= */
    // Reemplaza con la IP de la computadora donde corre tu Servidor Java
    const PROXY_SERVER = "http://localhost:8080/stream-galpon"; 
    // Para mover la c√°mara seguimos usando la IP directa (el Proxy Java tambi√©n podr√≠a hacerlo)
    const CAM_IP = "http://192.168.2.193:88/cgi-bin/CGIProxy.fcgi?usr=alex&pwd=F7324088";

    /* ================= FIREBASE ================= */
    const firebaseConfig = { databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ================= GAUGES ================= */
    const gOpts = {
        angle: -0.2, lineWidth: 0.2,
        pointer: { length: 0.6, color: "#fff" },
        staticZones: [
            {strokeColor: "#22c55e", min: 0, max: 20},
            {strokeColor: "#ef4444", min: 20, max: 100}
        ]
    };
    const gNH3 = new Gauge(document.getElementById("gauge-nh3")).setOptions(gOpts);
    const gTemp = new Gauge(document.getElementById("gauge-temp")).setOptions(gOpts);
    gNH3.maxValue = 100; gTemp.maxValue = 50;

    /* ================= L√ìGICA DE VIDEO ================= */
    function conectarStream() {
        const img = document.getElementById("video-stream");
        const status = document.getElementById("status-text");
        const btn = document.getElementById("btn-stream");

        img.style.display = "block";
        status.style.display = "none";
        btn.innerText = "‚úÖ RECIBIENDO DESDE JAVA";
        btn.style.background = "#22c55e";

        // El navegador ahora pide el video al servidor Java, no a la c√°mara.
        // Esto evita el error de Mixed Content de GitHub.
        setInterval(() => {
            img.src = PROXY_SERVER + "?ts=" + Date.now();
        }, 800); 
    }

    function controlar(comando) {
        // Enviamos el comando de movimiento a trav√©s de un objeto Image (Truco silencioso)
        const ping = new Image();
        ping.src = CAM_IP + "&cmd=" + comando + "&_ts=" + Date.now();
    }

    /* ================= ACTUALIZACI√ìN SENSORES ================= */
    db.ref("galpon/actual").on("value", snap => {
        const data = snap.val();
        if(!data) return;

        // NH3
        if(data.nh3_ppm != null) {
            gNH3.set(data.nh3_ppm);
            const el = document.getElementById("val-nh3");
            const lbl = document.getElementById("label-nh3");
            el.innerText = data.nh3_ppm + " ppm";
            el.style.color = data.nh3_ppm > 20 ? "#ef4444" : "#22c55e";
            lbl.innerText = data.nh3_ppm > 20 ? "üö® NIVEL CR√çTICO" : "‚úÖ AIRE SEGURO";
            lbl.style.color = data.nh3_ppm > 20 ? "#ef4444" : "#22c55e";
        }

        // Temperatura
        if(data.temperatura != null) {
            gTemp.set(data.temperatura);
            const elT = document.getElementById("val-temp");
            const lblT = document.getElementById("label-temp");
            elT.innerText = data.temperatura + "¬∞C";
            elT.style.color = data.temperatura > 31 ? "#ef4444" : "#22c55e";
            lblT.innerText = data.temperatura > 31 ? "üö® ALTA TEMPERATURA" : "‚úÖ TEMPERATURA OK";
            lblT.style.color = data.temperatura > 31 ? "#ef4444" : "#22c55e";
        }
    });
</script>

</body>
</html>
