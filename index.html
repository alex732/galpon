<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Capell√°n Cloud | Dashboard</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gaugeJS/dist/gauge.min.js"></script>
    <style>
        body { background: #0f172a; color: #f8fafc; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; max-width: 1100px; margin: auto; }
        .card { background: #1e293b; border-radius: 15px; padding: 20px; border: 4px solid #334155; }
        .val { font-size: 3rem; font-weight: bold; color: #3b82f6; margin: 10px 0; }
        .cam-box { width: 100%; height: 320px; background: #000; border-radius: 10px; border: 2px solid #3b82f6; overflow: hidden; display: flex; align-items: center; justify-content: center; position: relative; }
        #foscam-stream { width: 100%; height: 100%; object-fit: contain; display: none; }
        .btn { background: #ef4444; color: white; border: none; padding: 15px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; margin-bottom: 10px; }
        .ptz-btn { background: #334155; color: white; border: none; padding: 10px; margin: 2px; width: 55px; border-radius: 5px; cursor: pointer; font-size: 1.2rem; }
    </style>
</head>
<body>

    <h1 style="color:#3b82f6">CONTROL CAPELL√ÅN CLOUD üö¶</h1>

    <div class="grid">
        <div class="card">
            <h3>AMON√çACO (NH3)</h3>
            <canvas id="g1" style="width:100%"></canvas>
            <div id="v1" class="val">--</div>
        </div>

        <div class="card">
            <h3>TEMPERATURA</h3>
            <canvas id="g2" style="width:100%"></canvas>
            <div id="v2" class="val">--</div>
        </div>

        <div class="card">
            <button class="btn" onclick="activar()">1. AUTORIZAR Y VER C√ÅMARA</button>
            <div class="cam-box">
                <img id="foscam-stream">
                <p id="t1" style="color:#475569;">C√°mara Desconectada</p>
            </div>
            <div style="margin-top:10px">
                <button class="ptz-btn" onclick="mv('ptzMoveUp')">‚ñ≤</button><br>
                <button class="ptz-btn" onclick="mv('ptzMoveLeft')">‚óÑ</button>
                <button class="ptz-btn" onclick="mv('ptzReset')">üè†</button>
                <button class="ptz-btn" onclick="mv('ptzMoveRight')">‚ñ∫</button><br>
                <button class="ptz-btn" onclick="mv('ptzMoveDown')">‚ñº</button>
            </div>
        </div>
    </div>

    <script>
        const USR="alex", PWD="F7324088", IP="192.168.2.193:88";
        const url = "http://" + IP + "/cgi-bin/CGIProxy.fcgi?usr=" + USR + "&pwd=" + PWD;

        firebase.initializeApp({ databaseURL: "https://galpon-capellan-default-rtdb.firebaseio.com" });
        const db = firebase.database();

        const opt = { angle:-0.2, lineWidth:0.2, pointer:{length:0.6,color:"#fff"}, staticZones:[{strokeColor:"#22c55e",min:0,max:20},{strokeColor:"#ef4444",min:20,max:100}] };
        const g1 = new Gauge(document.getElementById("g1")).setOptions(opt);
        const g2 = new Gauge(document.getElementById("g2")).setOptions(opt);
        g1.maxValue=100; g2.maxValue=50;

        function activar() {
            // Abrimos la ventana que da el permiso
            window.open(url + "&cmd=getDevState", "auth", "width=300,height=200");
            
            setTimeout(() => {
                const img = document.getElementById("foscam-stream");
                img.style.display = "block";
                document.getElementById("t1").style.display = "none";
                
                // Modo R√°faga
                setInterval(() => {
                    img.src = url + "&cmd=snapShot&_ts=" + Date.now();
                }, 1000);

                const b = document.querySelector(".btn");
                b.innerText = "‚úÖ VIDEO EN VIVO";
                b.style.background = "#22c55e";
            }, 2000);
        }

        function mv(c) { 
            const i = new Image();
            i.src = url + "&cmd=" + c + "&_ts=" + Date.now();
        }

        db.ref("galpon/actual").on("value", s => {
            const d = s.val();
            if(d) {
                g1.set(d.nh3_ppm); document.getElementById("v1").innerText = d.nh3_ppm + " ppm";
                g2.set(d.temperatura); document.getElementById("v2").innerText = d.temperatura + " ¬∞C";
            }
        });
    </script>
</body>
</html>
